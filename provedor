                                                                                                                                                     
● Parte 30: services/ai/index.ts (85 linhas)                                                                                                         
                                                                                                                                                     
  // Claude Client                                                                                                                                   
  export { ClaudeClient, createClaudeClient } from './claude';                                                                                       
                                                                                                                                                     
  // Gemini Client                                                                                                                                   
  export {                                                                                                                                           
    GeminiClient,                                                                                                                                    
    createGeminiClient,                                                                                                                              
    type GeminiConfig,                                                                                                                               
    type GeminiMessage,                                                                                                                              
    type GeminiChatOptions,                                                                                                                          
    type GeminiResponse,                                                                                                                             
    type GeminiStreamOptions,                                                                                                                        
  } from './gemini-client';                                                                                                                          
                                                                                                                                                     
  // OpenAI Client                                                                                                                                   
  export {                                                                                                                                           
    OpenAIClient,                                                                                                                                    
    createOpenAIClient,                                                                                                                              
    type OpenAIConfig,                                                                                                                               
    type OpenAIMessage,                                                                                                                              
    type OpenAIChatOptions,                                                                                                                          
    type OpenAIResponse,                                                                                                                             
  } from './openai-client';                                                                                                                          
                                                                                                                                                     
  // Unified AI Factory                                                                                                                              
  export {                                                                                                                                           
    UnifiedAIClient,                                                                                                                                 
    createAIClient,                                                                                                                                  
    createAIClientFromAgent,                                                                                                                         
    AI_MODELS,                                                                                                                                       
    DEFAULT_MODELS,                                                                                                                                  
    type AIProvider,                                                                                                                                 
    type AIConfig,                                                                                                                                   
    type AIMessage,                                                                                                                                  
    type AIChatOptions,                                                                                                                              
    type AIResponse,                                                                                                                                 
    type AIFunctionDeclaration,                                                                                                                      
    type AIFunctionCall,                                                                                                                             
    type AIFunctionCallingMode,                                                                                                                      
    type AIChatWithToolsOptions,                                                                                                                     
    type AIResponseWithTools,                                                                                                                        
  } from './ai-factory';                                                                                                                             
                                                                                                                                                     
  // Whisper Client                                                                                                                                  
  export { WhisperClient, createWhisperClient } from './whisper';                                                                                    
                                                                                                                                                     
  // Types                                                                                                                                           
  export {                                                                                                                                           
    // Message Types                                                                                                                                 
    type MessageRole,                                                                                                                                
    type ClaudeMessage,                                                                                                                              
    type ClaudeResponse,                                                                                                                             
    type StopReason,                                                                                                                                 
    type Usage,                                                                                                                                      
                                                                                                                                                     
    // Content Blocks                                                                                                                                
    type ContentBlock,                                                                                                                               
    type TextBlock,                                                                                                                                  
    type ImageBlock,                                                                                                                                 
    type ImageSource,                                                                                                                                
                                                                                                                                                     
    // Tool Types                                                                                                                                    
    type ToolDefinition,                                                                                                                             
    type PropertySchema,                                                                                                                             
    type ToolUseBlock,                                                                                                                               
    type ToolResultBlock,                                                                                                                            
    type ToolChoice,                                                                                                                                 
                                                                                                                                                     
    // Request Params                                                                                                                                
    type SendMessageParams,                                                                                                                          
    type SendWithToolsParams,                                                                                                                        
                                                                                                                                                     
    // Whisper Types                                                                                                                                 
    type TranscriptionParams,                                                                                                                        
    type TranscriptionResult,                                                                                                                        
                                                                                                                                                     
    // Helper Functions                                                                                                                              
    extractTextFromResponse,                                                                                                                         
    extractToolUses,                                                                                                                                 
    hasToolUse,                                                                                                                                      
    createTextBlock,                                                                                                                                 
    createImageBlock,                                                                                                                                
    createToolResult,                                                                                                                                
  } from './types';                                                                                                                                  
                                                                                                                                                     
  ---                                                                                                                                                
  Parte 31: services/ai/types.ts (234 linhas)                                                                                                        
                                                                                                                                                     
  // ============================================================================                                                                    
  // CLAUDE MESSAGE TYPES                                                                                                                            
  // ============================================================================                                                                    
                                                                                                                                                     
  export type MessageRole = 'user' | 'assistant';                                                                                                    
                                                                                                                                                     
  export interface ClaudeMessage {                                                                                                                   
    role: MessageRole;                                                                                                                               
    content: string | ContentBlock[];                                                                                                                
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // CONTENT BLOCKS                                                                                                                                  
  // ============================================================================                                                                    
                                                                                                                                                     
  export type ContentBlock =                                                                                                                         
    | TextBlock                                                                                                                                      
    | ImageBlock                                                                                                                                     
    | ToolUseBlock                                                                                                                                   
    | ToolResultBlock                                                                                                                                
    | ThinkingBlock;                                                                                                                                 
                                                                                                                                                     
  export interface ThinkingBlock {                                                                                                                   
    type: 'thinking';                                                                                                                                
    thinking: string;                                                                                                                                
  }                                                                                                                                                  
                                                                                                                                                     
  export interface TextBlock {                                                                                                                       
    type: 'text';                                                                                                                                    
    text: string;                                                                                                                                    
  }                                                                                                                                                  
                                                                                                                                                     
  export interface ImageBlock {                                                                                                                      
    type: 'image';                                                                                                                                   
    source: ImageSource;                                                                                                                             
  }                                                                                                                                                  
                                                                                                                                                     
  export interface ImageSource {                                                                                                                     
    type: 'base64';                                                                                                                                  
    media_type: 'image/jpeg' | 'image/png' | 'image/gif' | 'image/webp';                                                                             
    data: string;                                                                                                                                    
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // TOOL TYPES                                                                                                                                      
  // ============================================================================                                                                    
                                                                                                                                                     
  export interface ToolDefinition {                                                                                                                  
    name: string;                                                                                                                                    
    description: string;                                                                                                                             
    input_schema: {                                                                                                                                  
      type: 'object';                                                                                                                                
      properties: Record<string, PropertySchema>;                                                                                                    
      required?: string[];                                                                                                                           
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  export interface PropertySchema {                                                                                                                  
    type: 'string' | 'number' | 'boolean' | 'array' | 'object';                                                                                      
    description?: string;                                                                                                                            
    enum?: string[];                                                                                                                                 
    items?: PropertySchema;                                                                                                                          
    properties?: Record<string, PropertySchema>;                                                                                                     
    required?: string[];                                                                                                                             
  }                                                                                                                                                  
                                                                                                                                                     
  export interface ToolUseBlock {                                                                                                                    
    type: 'tool_use';                                                                                                                                
    id: string;                                                                                                                                      
    name: string;                                                                                                                                    
    input: Record<string, unknown>;                                                                                                                  
  }                                                                                                                                                  
                                                                                                                                                     
  export interface ToolResultBlock {                                                                                                                 
    type: 'tool_result';                                                                                                                             
    tool_use_id: string;                                                                                                                             
    content: string | ContentBlock[];                                                                                                                
    is_error?: boolean;                                                                                                                              
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // CLAUDE RESPONSE                                                                                                                                 
  // ============================================================================                                                                    
                                                                                                                                                     
  export interface ClaudeResponse {                                                                                                                  
    id: string;                                                                                                                                      
    type: 'message';                                                                                                                                 
    role: 'assistant';                                                                                                                               
    content: ContentBlock[];                                                                                                                         
    model: string;                                                                                                                                   
    stop_reason: StopReason;                                                                                                                         
    stop_sequence: string | null;                                                                                                                    
    usage: Usage;                                                                                                                                    
  }                                                                                                                                                  
                                                                                                                                                     
  export type StopReason = 'end_turn' | 'max_tokens' | 'stop_sequence' | 'tool_use';                                                                 
                                                                                                                                                     
  export interface Usage {                                                                                                                           
    input_tokens: number;                                                                                                                            
    output_tokens: number;                                                                                                                           
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // REQUEST PARAMS                                                                                                                                  
  // ============================================================================                                                                    
                                                                                                                                                     
  export interface ThinkingConfig {                                                                                                                  
    type: 'enabled';                                                                                                                                 
    budget_tokens: number;                                                                                                                           
  }                                                                                                                                                  
                                                                                                                                                     
  export interface SendMessageParams {                                                                                                               
    systemPrompt: string;                                                                                                                            
    messages: ClaudeMessage[];                                                                                                                       
    tools?: ToolDefinition[];                                                                                                                        
    maxTokens?: number;                                                                                                                              
    temperature?: number;                                                                                                                            
    stopSequences?: string[];                                                                                                                        
    thinking?: ThinkingConfig;                                                                                                                       
  }                                                                                                                                                  
                                                                                                                                                     
  export interface SendWithToolsParams {                                                                                                             
    systemPrompt: string;                                                                                                                            
    messages: ClaudeMessage[];                                                                                                                       
    tools: ToolDefinition[];                                                                                                                         
    maxTokens?: number;                                                                                                                              
    temperature?: number;                                                                                                                            
    toolChoice?: ToolChoice;                                                                                                                         
    thinking?: ThinkingConfig;                                                                                                                       
  }                                                                                                                                                  
                                                                                                                                                     
  export type ToolChoice =                                                                                                                           
    | { type: 'auto' }                                                                                                                               
    | { type: 'any' }                                                                                                                                
    | { type: 'tool'; name: string };                                                                                                                
                                                                                                                                                     
  // ============================================================================                                                                    
  // WHISPER TYPES                                                                                                                                   
  // ============================================================================                                                                    
                                                                                                                                                     
  export interface TranscriptionParams {                                                                                                             
    audioBase64: string;                                                                                                                             
    mimeType: string;                                                                                                                                
    language?: string;                                                                                                                               
    prompt?: string;                                                                                                                                 
  }                                                                                                                                                  
                                                                                                                                                     
  export interface TranscriptionResult {                                                                                                             
    text: string;                                                                                                                                    
    language?: string;                                                                                                                               
    duration?: number;                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // HELPERS                                                                                                                                         
  // ============================================================================                                                                    
                                                                                                                                                     
  /**                                                                                                                                                
   * Extrai o texto de uma resposta do Claude                                                                                                        
   */                                                                                                                                                
  export function extractTextFromResponse(response: ClaudeResponse): string {                                                                        
    const textBlocks = response.content.filter(                                                                                                      
      (block): block is TextBlock => block.type === 'text'                                                                                           
    );                                                                                                                                               
                                                                                                                                                     
    return textBlocks.map((block) => block.text).join('\n');                                                                                         
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Extrai tool uses de uma resposta do Claude                                                                                                      
   */                                                                                                                                                
  export function extractToolUses(response: ClaudeResponse): ToolUseBlock[] {                                                                        
    return response.content.filter(                                                                                                                  
      (block): block is ToolUseBlock => block.type === 'tool_use'                                                                                    
    );                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Extrai thinking blocks de uma resposta do Claude                                                                                                
   */                                                                                                                                                
  export function extractThinking(response: ClaudeResponse): string {                                                                                
    const thinkingBlocks = response.content.filter(                                                                                                  
      (block): block is ThinkingBlock => block.type === 'thinking'                                                                                   
    );                                                                                                                                               
    return thinkingBlocks.map((block) => block.thinking).join('\n');                                                                                 
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Verifica se a resposta contém tool uses                                                                                                         
   */                                                                                                                                                
  export function hasToolUse(response: ClaudeResponse): boolean {                                                                                    
    return response.stop_reason === 'tool_use';                                                                                                      
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Cria um bloco de texto                                                                                                                          
   */                                                                                                                                                
  export function createTextBlock(text: string): TextBlock {                                                                                         
    return { type: 'text', text };                                                                                                                   
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Cria um bloco de imagem                                                                                                                         
   */                                                                                                                                                
  export function createImageBlock(                                                                                                                  
    base64: string,                                                                                                                                  
    mediaType: ImageSource['media_type']                                                                                                             
  ): ImageBlock {                                                                                                                                    
    return {                                                                                                                                         
      type: 'image',                                                                                                                                 
      source: {                                                                                                                                      
        type: 'base64',                                                                                                                              
        media_type: mediaType,                                                                                                                       
        data: base64,                                                                                                                                
      },                                                                                                                                             
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Cria um bloco de resultado de tool                                                                                                              
   */                                                                                                                                                
  export function createToolResult(                                                                                                                  
    toolUseId: string,                                                                                                                               
    content: string,                                                                                                                                 
    isError: boolean = false                                                                                                                         
  ): ToolResultBlock {                                                                                                                               
    return {                                                                                                                                         
      type: 'tool_result',                                                                                                                           
      tool_use_id: toolUseId,                                                                                                                        
      content,                                                                                                                                       
      is_error: isError,                                                                                                                             
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  ---                                                                                                                                                
  Parte 32: services/ai/claude.ts (268 linhas)                                                                                                       
                                                                                                                                                     
  import Anthropic from '@anthropic-ai/sdk';                                                                                                         
  import {                                                                                                                                           
    ClaudeMessage,                                                                                                                                   
    ClaudeResponse,                                                                                                                                  
    ToolDefinition,                                                                                                                                  
    SendMessageParams,                                                                                                                               
    SendWithToolsParams,                                                                                                                             
    ContentBlock,                                                                                                                                    
    ThinkingConfig,                                                                                                                                  
  } from './types';                                                                                                                                  
                                                                                                                                                     
  const DEFAULT_MODEL = 'claude-sonnet-4-20250514';                                                                                                  
  const DEFAULT_MAX_TOKENS = 4096;                                                                                                                   
  const MAX_RETRIES = 3;                                                                                                                             
  const RETRY_DELAY_MS = 1000;                                                                                                                       
                                                                                                                                                     
  export class ClaudeClient {                                                                                                                        
    private client: Anthropic;                                                                                                                       
    private model: string;                                                                                                                           
                                                                                                                                                     
    constructor(apiKey: string, model?: string) {                                                                                                    
      this.client = new Anthropic({                                                                                                                  
        apiKey,                                                                                                                                      
      });                                                                                                                                            
      this.model = model || DEFAULT_MODEL;                                                                                                           
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Envia uma mensagem para o Claude                                                                                                              
     */                                                                                                                                              
    async sendMessage(params: SendMessageParams): Promise<ClaudeResponse> {                                                                          
      const {                                                                                                                                        
        systemPrompt,                                                                                                                                
        messages,                                                                                                                                    
        tools,                                                                                                                                       
        maxTokens = DEFAULT_MAX_TOKENS,                                                                                                              
        temperature = 0.7,                                                                                                                           
        stopSequences,                                                                                                                               
        thinking,                                                                                                                                    
      } = params;                                                                                                                                    
                                                                                                                                                     
      return this.executeWithRetry(async () => {                                                                                                     
        // Quando thinking está habilitado, temperature deve ser 1                                                                                   
        const effectiveTemperature = thinking ? 1 : temperature;                                                                                     
                                                                                                                                                     
        const requestParams: Anthropic.MessageCreateParams = {                                                                                       
          model: this.model,                                                                                                                         
          max_tokens: maxTokens,                                                                                                                     
          temperature: effectiveTemperature,                                                                                                         
          system: systemPrompt,                                                                                                                      
          messages: this.formatMessages(messages),                                                                                                   
          tools: tools ? this.formatTools(tools) : undefined,                                                                                        
          stop_sequences: stopSequences,                                                                                                             
        };                                                                                                                                           
                                                                                                                                                     
        // Adiciona thinking se habilitado                                                                                                           
        if (thinking) {                                                                                                                              
          (requestParams as any).thinking = thinking;                                                                                                
        }                                                                                                                                            
                                                                                                                                                     
        const response = await this.client.messages.create(requestParams);                                                                           
                                                                                                                                                     
        return this.parseResponse(response);                                                                                                         
      });                                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Envia mensagem com tools habilitadas                                                                                                          
     */                                                                                                                                              
    async sendWithTools(params: SendWithToolsParams): Promise<ClaudeResponse> {                                                                      
      const {                                                                                                                                        
        systemPrompt,                                                                                                                                
        messages,                                                                                                                                    
        tools,                                                                                                                                       
        maxTokens = DEFAULT_MAX_TOKENS,                                                                                                              
        temperature = 0.7,                                                                                                                           
        toolChoice,                                                                                                                                  
        thinking,                                                                                                                                    
      } = params;                                                                                                                                    
                                                                                                                                                     
      return this.executeWithRetry(async () => {                                                                                                     
        // Quando thinking está habilitado, temperature deve ser 1                                                                                   
        const effectiveTemperature = thinking ? 1 : temperature;                                                                                     
                                                                                                                                                     
        const requestParams: Anthropic.MessageCreateParams = {                                                                                       
          model: this.model,                                                                                                                         
          max_tokens: maxTokens,                                                                                                                     
          temperature: effectiveTemperature,                                                                                                         
          system: systemPrompt,                                                                                                                      
          messages: this.formatMessages(messages),                                                                                                   
          tools: this.formatTools(tools),                                                                                                            
          tool_choice: toolChoice,                                                                                                                   
        };                                                                                                                                           
                                                                                                                                                     
        // Adiciona thinking se habilitado                                                                                                           
        if (thinking) {                                                                                                                              
          (requestParams as any).thinking = thinking;                                                                                                
        }                                                                                                                                            
                                                                                                                                                     
        const response = await this.client.messages.create(requestParams);                                                                           
                                                                                                                                                     
        return this.parseResponse(response);                                                                                                         
      });                                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Continua uma conversa após executar tools                                                                                                     
     */                                                                                                                                              
    async continueWithToolResults(                                                                                                                   
      params: SendMessageParams,                                                                                                                     
      previousResponse: ClaudeResponse,                                                                                                              
      toolResults: Array<{ tool_use_id: string; content: string; is_error?: boolean }>                                                               
    ): Promise<ClaudeResponse> {                                                                                                                     
      // Adiciona a resposta anterior do assistant e os resultados das tools                                                                         
      const updatedMessages: ClaudeMessage[] = [                                                                                                     
        ...params.messages,                                                                                                                          
        {                                                                                                                                            
          role: 'assistant',                                                                                                                         
          content: previousResponse.content as ContentBlock[],                                                                                       
        },                                                                                                                                           
        {                                                                                                                                            
          role: 'user',                                                                                                                              
          content: toolResults.map((result) => ({                                                                                                    
            type: 'tool_result' as const,                                                                                                            
            tool_use_id: result.tool_use_id,                                                                                                         
            content: result.content,                                                                                                                 
            is_error: result.is_error,                                                                                                               
          })),                                                                                                                                       
        },                                                                                                                                           
      ];                                                                                                                                             
                                                                                                                                                     
      return this.sendMessage({                                                                                                                      
        ...params,                                                                                                                                   
        messages: updatedMessages,                                                                                                                   
      });                                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Formata mensagens para o formato da API                                                                                                       
     */                                                                                                                                              
    private formatMessages(messages: ClaudeMessage[]): Anthropic.MessageParam[] {                                                                    
      return messages.map((msg) => ({                                                                                                                
        role: msg.role,                                                                                                                              
        content: msg.content,                                                                                                                        
      })) as Anthropic.MessageParam[];                                                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Formata tools para o formato da API                                                                                                           
     */                                                                                                                                              
    private formatTools(tools: ToolDefinition[]): Anthropic.Tool[] {                                                                                 
      return tools.map((tool) => ({                                                                                                                  
        name: tool.name,                                                                                                                             
        description: tool.description,                                                                                                               
        input_schema: tool.input_schema as Anthropic.Tool.InputSchema,                                                                               
      }));                                                                                                                                           
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Parseia a resposta da API para o formato interno                                                                                              
     */                                                                                                                                              
    private parseResponse(response: Anthropic.Message): ClaudeResponse {                                                                             
      return {                                                                                                                                       
        id: response.id,                                                                                                                             
        type: response.type,                                                                                                                         
        role: response.role,                                                                                                                         
        content: response.content as ContentBlock[],                                                                                                 
        model: response.model,                                                                                                                       
        stop_reason: response.stop_reason as ClaudeResponse['stop_reason'],                                                                          
        stop_sequence: response.stop_sequence,                                                                                                       
        usage: {                                                                                                                                     
          input_tokens: response.usage.input_tokens,                                                                                                 
          output_tokens: response.usage.output_tokens,                                                                                               
        },                                                                                                                                           
      };                                                                                                                                             
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Executa uma operação com retry automático                                                                                                     
     */                                                                                                                                              
    private async executeWithRetry<T>(                                                                                                               
      operation: () => Promise<T>,                                                                                                                   
      retries: number = MAX_RETRIES                                                                                                                  
    ): Promise<T> {                                                                                                                                  
      let lastError: Error | null = null;                                                                                                            
                                                                                                                                                     
      for (let attempt = 1; attempt <= retries; attempt++) {                                                                                         
        try {                                                                                                                                        
          return await operation();                                                                                                                  
        } catch (error) {                                                                                                                            
          lastError = error instanceof Error ? error : new Error(String(error));                                                                     
                                                                                                                                                     
          // Verificar se é um erro recuperável                                                                                                      
          if (this.isRetryableError(error) && attempt < retries) {                                                                                   
            console.warn(                                                                                                                            
              `[ClaudeClient] Attempt ${attempt} failed, retrying in ${RETRY_DELAY_MS * attempt}ms...`,                                              
              lastError.message                                                                                                                      
            );                                                                                                                                       
            await this.delay(RETRY_DELAY_MS * attempt);                                                                                              
            continue;                                                                                                                                
          }                                                                                                                                          
                                                                                                                                                     
          // Erro não recuperável ou última tentativa                                                                                                
          break;                                                                                                                                     
        }                                                                                                                                            
      }                                                                                                                                              
                                                                                                                                                     
      console.error('[ClaudeClient] All retry attempts failed:', lastError);                                                                         
      throw lastError;                                                                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Verifica se o erro é recuperável                                                                                                              
     */                                                                                                                                              
    private isRetryableError(error: unknown): boolean {                                                                                              
      if (error instanceof Anthropic.APIError) {                                                                                                     
        // Retry em erros de rate limit ou servidor                                                                                                  
        return (                                                                                                                                     
          error.status === 429 || // Rate limit                                                                                                      
          error.status === 500 || // Internal server error                                                                                           
          error.status === 502 || // Bad gateway                                                                                                     
          error.status === 503 || // Service unavailable                                                                                             
          error.status === 504 // Gateway timeout                                                                                                    
        );                                                                                                                                           
      }                                                                                                                                              
                                                                                                                                                     
      // Retry em erros de rede                                                                                                                      
      if (error instanceof Error) {                                                                                                                  
        return (                                                                                                                                     
          error.message.includes('ECONNRESET') ||                                                                                                    
          error.message.includes('ETIMEDOUT') ||                                                                                                     
          error.message.includes('ENOTFOUND') ||                                                                                                     
          error.message.includes('socket hang up')                                                                                                   
        );                                                                                                                                           
      }                                                                                                                                              
                                                                                                                                                     
      return false;                                                                                                                                  
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Helper para delay                                                                                                                             
     */                                                                                                                                              
    private delay(ms: number): Promise<void> {                                                                                                       
      return new Promise((resolve) => setTimeout(resolve, ms));                                                                                      
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Atualiza o modelo usado                                                                                                                       
     */                                                                                                                                              
    setModel(model: string): void {                                                                                                                  
      this.model = model;                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Retorna o modelo atual                                                                                                                        
     */                                                                                                                                              
    getModel(): string {                                                                                                                             
      return this.model;                                                                                                                             
    }                                                                                                                                                
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Factory function para criar cliente Claude                                                                                                      
   */                                                                                                                                                
  export function createClaudeClient(apiKey: string, model?: string): ClaudeClient {                                                                 
    return new ClaudeClient(apiKey, model);                                                                                                          
  }                                                                                                                                                  
                                                                                                                                                     
  ---                                                                                                                                                
  Parte 33: services/ai/whisper.ts (213 linhas)                                                                                                      
                                                                                                                                                     
  import OpenAI from 'openai';                                                                                                                       
  import { TranscriptionParams, TranscriptionResult } from './types';                                                                                
                                                                                                                                                     
  const DEFAULT_MODEL = 'whisper-1';                                                                                                                 
  const DEFAULT_LANGUAGE = 'pt';                                                                                                                     
  const MAX_RETRIES = 2;                                                                                                                             
  const RETRY_DELAY_MS = 1000;                                                                                                                       
                                                                                                                                                     
  export class WhisperClient {                                                                                                                       
    private client: OpenAI;                                                                                                                          
    private model: string;                                                                                                                           
    private defaultLanguage: string;                                                                                                                 
                                                                                                                                                     
    constructor(apiKey: string, model?: string, defaultLanguage?: string) {                                                                          
      this.client = new OpenAI({                                                                                                                     
        apiKey,                                                                                                                                      
      });                                                                                                                                            
      this.model = model || DEFAULT_MODEL;                                                                                                           
      this.defaultLanguage = defaultLanguage || DEFAULT_LANGUAGE;                                                                                    
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Transcreve um áudio em base64 para texto                                                                                                      
     */                                                                                                                                              
    async transcribe(params: TranscriptionParams): Promise<TranscriptionResult> {                                                                    
      const {                                                                                                                                        
        audioBase64,                                                                                                                                 
        mimeType,                                                                                                                                    
        language = this.defaultLanguage,                                                                                                             
        prompt,                                                                                                                                      
      } = params;                                                                                                                                    
                                                                                                                                                     
      return this.executeWithRetry(async () => {                                                                                                     
        // Converter base64 para File                                                                                                                
        const file = this.base64ToFile(audioBase64, mimeType);                                                                                       
                                                                                                                                                     
        const response = await this.client.audio.transcriptions.create({                                                                             
          file,                                                                                                                                      
          model: this.model,                                                                                                                         
          language,                                                                                                                                  
          prompt,                                                                                                                                    
          response_format: 'verbose_json',                                                                                                           
        });                                                                                                                                          
                                                                                                                                                     
        return {                                                                                                                                     
          text: response.text,                                                                                                                       
          language: response.language,                                                                                                               
          duration: response.duration,                                                                                                               
        };                                                                                                                                           
      });                                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Transcreve um áudio diretamente de base64 (método simplificado)                                                                               
     */                                                                                                                                              
    async transcribeBase64(audioBase64: string, mimeType: string): Promise<string> {                                                                 
      const result = await this.transcribe({ audioBase64, mimeType });                                                                               
      return result.text;                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Converte base64 para File                                                                                                                     
     */                                                                                                                                              
    private base64ToFile(base64: string, mimeType: string): File {                                                                                   
      // Remover prefixo data:audio/xxx;base64, se presente                                                                                          
      const cleanBase64 = base64.replace(/^data:audio\/[a-z]+;base64,/, '');                                                                         
                                                                                                                                                     
      // Converter para buffer                                                                                                                       
      const buffer = Buffer.from(cleanBase64, 'base64');                                                                                             
                                                                                                                                                     
      // Determinar extensão do arquivo                                                                                                              
      const extension = this.getExtensionFromMimeType(mimeType);                                                                                     
      const fileName = `audio.${extension}`;                                                                                                         
                                                                                                                                                     
      // Criar Blob e File                                                                                                                           
      const blob = new Blob([buffer], { type: mimeType });                                                                                           
      return new File([blob], fileName, { type: mimeType });                                                                                         
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Obtém a extensão do arquivo a partir do mimeType                                                                                              
     */                                                                                                                                              
    private getExtensionFromMimeType(mimeType: string): string {                                                                                     
      const mimeToExtension: Record<string, string> = {                                                                                              
        'audio/ogg': 'ogg',                                                                                                                          
        'audio/ogg; codecs=opus': 'ogg',                                                                                                             
        'audio/opus': 'opus',                                                                                                                        
        'audio/mpeg': 'mp3',                                                                                                                         
        'audio/mp3': 'mp3',                                                                                                                          
        'audio/mp4': 'm4a',                                                                                                                          
        'audio/m4a': 'm4a',                                                                                                                          
        'audio/wav': 'wav',                                                                                                                          
        'audio/wave': 'wav',                                                                                                                         
        'audio/x-wav': 'wav',                                                                                                                        
        'audio/webm': 'webm',                                                                                                                        
        'audio/flac': 'flac',                                                                                                                        
      };                                                                                                                                             
                                                                                                                                                     
      // Normalizar mimeType (remover parâmetros extras)                                                                                             
      const normalizedMime = mimeType.split(';')[0].trim().toLowerCase();                                                                            
                                                                                                                                                     
      return mimeToExtension[normalizedMime] || 'ogg';                                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Executa uma operação com retry automático                                                                                                     
     */                                                                                                                                              
    private async executeWithRetry<T>(                                                                                                               
      operation: () => Promise<T>,                                                                                                                   
      retries: number = MAX_RETRIES                                                                                                                  
    ): Promise<T> {                                                                                                                                  
      let lastError: Error | null = null;                                                                                                            
                                                                                                                                                     
      for (let attempt = 1; attempt <= retries; attempt++) {                                                                                         
        try {                                                                                                                                        
          return await operation();                                                                                                                  
        } catch (error) {                                                                                                                            
          lastError = error instanceof Error ? error : new Error(String(error));                                                                     
                                                                                                                                                     
          // Verificar se é um erro recuperável                                                                                                      
          if (this.isRetryableError(error) && attempt < retries) {                                                                                   
            console.warn(                                                                                                                            
              `[WhisperClient] Attempt ${attempt} failed, retrying in ${RETRY_DELAY_MS * attempt}ms...`,                                             
              lastError.message                                                                                                                      
            );                                                                                                                                       
            await this.delay(RETRY_DELAY_MS * attempt);                                                                                              
            continue;                                                                                                                                
          }                                                                                                                                          
                                                                                                                                                     
          // Erro não recuperável ou última tentativa                                                                                                
          break;                                                                                                                                     
        }                                                                                                                                            
      }                                                                                                                                              
                                                                                                                                                     
      console.error('[WhisperClient] All retry attempts failed:', lastError);                                                                        
      throw lastError;                                                                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Verifica se o erro é recuperável                                                                                                              
     */                                                                                                                                              
    private isRetryableError(error: unknown): boolean {                                                                                              
      if (error instanceof OpenAI.APIError) {                                                                                                        
        // Retry em erros de rate limit ou servidor                                                                                                  
        return (                                                                                                                                     
          error.status === 429 || // Rate limit                                                                                                      
          error.status === 500 || // Internal server error                                                                                           
          error.status === 502 || // Bad gateway                                                                                                     
          error.status === 503 || // Service unavailable                                                                                             
          error.status === 504 // Gateway timeout                                                                                                    
        );                                                                                                                                           
      }                                                                                                                                              
                                                                                                                                                     
      // Retry em erros de rede                                                                                                                      
      if (error instanceof Error) {                                                                                                                  
        return (                                                                                                                                     
          error.message.includes('ECONNRESET') ||                                                                                                    
          error.message.includes('ETIMEDOUT') ||                                                                                                     
          error.message.includes('ENOTFOUND') ||                                                                                                     
          error.message.includes('socket hang up')                                                                                                   
        );                                                                                                                                           
      }                                                                                                                                              
                                                                                                                                                     
      return false;                                                                                                                                  
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Helper para delay                                                                                                                             
     */                                                                                                                                              
    private delay(ms: number): Promise<void> {                                                                                                       
      return new Promise((resolve) => setTimeout(resolve, ms));                                                                                      
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Atualiza o modelo usado                                                                                                                       
     */                                                                                                                                              
    setModel(model: string): void {                                                                                                                  
      this.model = model;                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Retorna o modelo atual                                                                                                                        
     */                                                                                                                                              
    getModel(): string {                                                                                                                             
      return this.model;                                                                                                                             
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Atualiza o idioma padrão                                                                                                                      
     */                                                                                                                                              
    setDefaultLanguage(language: string): void {                                                                                                     
      this.defaultLanguage = language;                                                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Retorna o idioma padrão atual                                                                                                                 
     */                                                                                                                                              
    getDefaultLanguage(): string {                                                                                                                   
      return this.defaultLanguage;                                                                                                                   
    }                                                                                                                                                
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Factory function para criar cliente Whisper                                                                                                     
   */                                                                                                                                                
  export function createWhisperClient(                                                                                                               
    apiKey: string,                                                                                                                                  
    model?: string,                                                                                                                                  
    defaultLanguage?: string                                                                                                                         
  ): WhisperClient {                                                                                                                                 
    return new WhisperClient(apiKey, model, defaultLanguage);                                                                                        
  }                                                                                                                                                  
                                                                                                                                                     
  ---                                                                                                                                                
  Parte 34: services/ai/openai-client.ts (408 linhas)                                                                                                
                                                                                                                                                     
  import OpenAI from 'openai';                                                                                                                       
                                                                                                                                                     
  // ============================================================================                                                                    
  // LOGGER                                                                                                                                          
  // ============================================================================                                                                    
                                                                                                                                                     
  interface Logger {                                                                                                                                 
    debug(message: string, data?: unknown): void;                                                                                                    
    info(message: string, data?: unknown): void;                                                                                                     
    warn(message: string, data?: unknown): void;                                                                                                     
    error(message: string, data?: unknown): void;                                                                                                    
  }                                                                                                                                                  
                                                                                                                                                     
  function createLogger(name: string): Logger {                                                                                                      
    return {                                                                                                                                         
      debug: (msg, data) => console.debug(`[${name}] ${msg}`, data ?? ''),                                                                           
      info: (msg, data) => console.info(`[${name}] ${msg}`, data ?? ''),                                                                             
      warn: (msg, data) => console.warn(`[${name}] ${msg}`, data ?? ''),                                                                             
      error: (msg, data) => console.error(`[${name}] ${msg}`, data ?? ''),                                                                           
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // OPENAI TYPES                                                                                                                                    
  // ============================================================================                                                                    
                                                                                                                                                     
  export interface OpenAIConfig {                                                                                                                    
    apiKey: string;                                                                                                                                  
    model?: string;                                                                                                                                  
  }                                                                                                                                                  
                                                                                                                                                     
  export interface OpenAIMessage {                                                                                                                   
    role: 'user' | 'assistant' | 'system';                                                                                                           
    content: string;                                                                                                                                 
  }                                                                                                                                                  
                                                                                                                                                     
  export interface OpenAIChatOptions {                                                                                                               
    systemPrompt?: string;                                                                                                                           
    history?: OpenAIMessage[];                                                                                                                       
    message: string;                                                                                                                                 
    maxTokens?: number;                                                                                                                              
    temperature?: number;                                                                                                                            
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // FUNCTION CALLING TYPES                                                                                                                          
  // ============================================================================                                                                    
                                                                                                                                                     
  export interface OpenAIFunctionDeclaration {                                                                                                       
    name: string;                                                                                                                                    
    description: string;                                                                                                                             
    parameters: {                                                                                                                                    
      type: 'object';                                                                                                                                
      properties: Record<string, {                                                                                                                   
        type: string;                                                                                                                                
        description?: string;                                                                                                                        
        enum?: string[];                                                                                                                             
      }>;                                                                                                                                            
      required?: string[];                                                                                                                           
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  export interface OpenAIFunctionCall {                                                                                                              
    name: string;                                                                                                                                    
    args: Record<string, unknown>;                                                                                                                   
  }                                                                                                                                                  
                                                                                                                                                     
  export type OpenAIFunctionCallingMode = 'auto' | 'required' | 'none';                                                                              
                                                                                                                                                     
  export interface OpenAIChatWithToolsOptions extends OpenAIChatOptions {                                                                            
    tools?: OpenAIFunctionDeclaration[];                                                                                                             
    onFunctionCall?: (functionCall: OpenAIFunctionCall) => Promise<Record<string, unknown>>;                                                         
    functionCallingMode?: OpenAIFunctionCallingMode;                                                                                                 
    allowedFunctions?: string[];                                                                                                                     
  }                                                                                                                                                  
                                                                                                                                                     
  export interface OpenAIResponse {                                                                                                                  
    text: string;                                                                                                                                    
    tokensUsed?: {                                                                                                                                   
      input: number;                                                                                                                                 
      output: number;                                                                                                                                
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  export interface OpenAIResponseWithTools extends OpenAIResponse {                                                                                  
    functionCall?: OpenAIFunctionCall;                                                                                                               
    finishReason?: string;                                                                                                                           
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // CONSTANTS                                                                                                                                       
  // ============================================================================                                                                    
                                                                                                                                                     
  const DEFAULT_MODEL = 'gpt-4o-mini';                                                                                                               
  const MAX_RETRIES = 3;                                                                                                                             
  const INITIAL_RETRY_DELAY_MS = 1000;                                                                                                               
                                                                                                                                                     
  // ============================================================================                                                                    
  // OPENAI CLIENT                                                                                                                                   
  // ============================================================================                                                                    
                                                                                                                                                     
  export class OpenAIClient {                                                                                                                        
    private client: OpenAI;                                                                                                                          
    private model: string;                                                                                                                           
    private logger: Logger;                                                                                                                          
                                                                                                                                                     
    constructor(config: OpenAIConfig) {                                                                                                              
      if (!config.apiKey) {                                                                                                                          
        throw new Error('OpenAIClient: apiKey is required');                                                                                         
      }                                                                                                                                              
                                                                                                                                                     
      this.client = new OpenAI({ apiKey: config.apiKey });                                                                                           
      this.model = config.model || DEFAULT_MODEL;                                                                                                    
      this.logger = createLogger('OpenAIClient');                                                                                                    
                                                                                                                                                     
      this.logger.info('Client initialized', { model: this.model });                                                                                 
    }                                                                                                                                                
                                                                                                                                                     
    // ========================================================================                                                                      
    // SIMPLE CHAT                                                                                                                                   
    // ========================================================================                                                                      
                                                                                                                                                     
    async chat(options: OpenAIChatOptions): Promise<OpenAIResponse> {                                                                                
      const { systemPrompt, history = [], message, maxTokens = 4096, temperature = 0.7 } = options;                                                  
                                                                                                                                                     
      this.logger.info('Starting chat', { model: this.model, messageLength: message.length });                                                       
                                                                                                                                                     
      const messages: OpenAI.ChatCompletionMessageParam[] = [];                                                                                      
                                                                                                                                                     
      // Adicionar system prompt                                                                                                                     
      if (systemPrompt) {                                                                                                                            
        messages.push({ role: 'system', content: systemPrompt });                                                                                    
      }                                                                                                                                              
                                                                                                                                                     
      // Adicionar historico                                                                                                                         
      for (const msg of history) {                                                                                                                   
        messages.push({ role: msg.role, content: msg.content });                                                                                     
      }                                                                                                                                              
                                                                                                                                                     
      // Adicionar mensagem atual                                                                                                                    
      messages.push({ role: 'user', content: message });                                                                                             
                                                                                                                                                     
      return this.executeWithRetry(async () => {                                                                                                     
        const response = await this.client.chat.completions.create({                                                                                 
          model: this.model,                                                                                                                         
          messages,                                                                                                                                  
          max_tokens: maxTokens,                                                                                                                     
          temperature,                                                                                                                               
        });                                                                                                                                          
                                                                                                                                                     
        const choice = response.choices[0];                                                                                                          
        const text = choice?.message?.content || '';                                                                                                 
                                                                                                                                                     
        this.logger.info('Chat completed', {                                                                                                         
          tokensUsed: response.usage?.total_tokens,                                                                                                  
          finishReason: choice?.finish_reason,                                                                                                       
        });                                                                                                                                          
                                                                                                                                                     
        return {                                                                                                                                     
          text,                                                                                                                                      
          tokensUsed: response.usage ? {                                                                                                             
            input: response.usage.prompt_tokens,                                                                                                     
            output: response.usage.completion_tokens,                                                                                                
          } : undefined,                                                                                                                             
        };                                                                                                                                           
      });                                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    // ========================================================================                                                                      
    // CHAT WITH TOOLS                                                                                                                               
    // ========================================================================                                                                      
                                                                                                                                                     
    async chatWithTools(options: OpenAIChatWithToolsOptions): Promise<OpenAIResponseWithTools> {                                                     
      const {                                                                                                                                        
        systemPrompt,                                                                                                                                
        history = [],                                                                                                                                
        message,                                                                                                                                     
        maxTokens = 4096,                                                                                                                            
        temperature = 0.7,                                                                                                                           
        tools = [],                                                                                                                                  
        onFunctionCall,                                                                                                                              
        functionCallingMode = 'auto',                                                                                                                
        allowedFunctions,                                                                                                                            
      } = options;                                                                                                                                   
                                                                                                                                                     
      this.logger.info('Starting chat with tools', {                                                                                                 
        model: this.model,                                                                                                                           
        toolCount: tools.length,                                                                                                                     
        mode: functionCallingMode,                                                                                                                   
      });                                                                                                                                            
                                                                                                                                                     
      const messages: OpenAI.ChatCompletionMessageParam[] = [];                                                                                      
                                                                                                                                                     
      // Adicionar system prompt                                                                                                                     
      if (systemPrompt) {                                                                                                                            
        messages.push({ role: 'system', content: systemPrompt });                                                                                    
      }                                                                                                                                              
                                                                                                                                                     
      // Adicionar historico                                                                                                                         
      for (const msg of history) {                                                                                                                   
        messages.push({ role: msg.role, content: msg.content });                                                                                     
      }                                                                                                                                              
                                                                                                                                                     
      // Adicionar mensagem atual                                                                                                                    
      messages.push({ role: 'user', content: message });                                                                                             
                                                                                                                                                     
      // Preparar tools no formato OpenAI                                                                                                            
      const openaiTools: OpenAI.ChatCompletionTool[] = tools.map(tool => ({                                                                          
        type: 'function',                                                                                                                            
        function: {                                                                                                                                  
          name: tool.name,                                                                                                                           
          description: tool.description,                                                                                                             
          parameters: tool.parameters as OpenAI.FunctionParameters,                                                                                  
        },                                                                                                                                           
      }));                                                                                                                                           
                                                                                                                                                     
      // Determinar tool_choice                                                                                                                      
      let toolChoice: OpenAI.ChatCompletionToolChoiceOption | undefined;                                                                             
      if (functionCallingMode === 'required') {                                                                                                      
        if (allowedFunctions && allowedFunctions.length === 1) {                                                                                     
          toolChoice = { type: 'function', function: { name: allowedFunctions[0] } };                                                                
        } else {                                                                                                                                     
          toolChoice = 'required';                                                                                                                   
        }                                                                                                                                            
      } else if (functionCallingMode === 'none') {                                                                                                   
        toolChoice = 'none';                                                                                                                         
      } else {                                                                                                                                       
        toolChoice = 'auto';                                                                                                                         
      }                                                                                                                                              
                                                                                                                                                     
      return this.executeWithRetry(async () => {                                                                                                     
        const response = await this.client.chat.completions.create({                                                                                 
          model: this.model,                                                                                                                         
          messages,                                                                                                                                  
          max_tokens: maxTokens,                                                                                                                     
          temperature,                                                                                                                               
          tools: openaiTools.length > 0 ? openaiTools : undefined,                                                                                   
          tool_choice: openaiTools.length > 0 ? toolChoice : undefined,                                                                              
        });                                                                                                                                          
                                                                                                                                                     
        const choice = response.choices[0];                                                                                                          
        const assistantMessage = choice?.message;                                                                                                    
                                                                                                                                                     
        // Verificar se tem tool call                                                                                                                
        if (assistantMessage?.tool_calls && assistantMessage.tool_calls.length > 0) {                                                                
          // Processar TODAS as tool calls, não só a primeira                                                                                        
          const allToolCalls = assistantMessage.tool_calls;                                                                                          
                                                                                                                                                     
          this.logger.info('Function calls detected', {                                                                                              
            count: allToolCalls.length,                                                                                                              
            functions: allToolCalls.map(tc => tc.function.name),                                                                                     
          });                                                                                                                                        
                                                                                                                                                     
          // Se tem callback, executar TODAS as tools e continuar                                                                                    
          if (onFunctionCall) {                                                                                                                      
            // Adicionar resposta do assistant com todas as tool calls                                                                               
            messages.push({                                                                                                                          
              role: 'assistant',                                                                                                                     
              content: assistantMessage.content,                                                                                                     
              tool_calls: assistantMessage.tool_calls,                                                                                               
            });                                                                                                                                      
                                                                                                                                                     
            // Processar CADA tool call e adicionar resposta                                                                                         
            let primaryFunctionCall: OpenAIFunctionCall | undefined;                                                                                 
            for (const toolCall of allToolCalls) {                                                                                                   
              const functionCall: OpenAIFunctionCall = {                                                                                             
                name: toolCall.function.name,                                                                                                        
                args: JSON.parse(toolCall.function.arguments || '{}'),                                                                               
              };                                                                                                                                     
                                                                                                                                                     
              // Guardar a primeira como principal                                                                                                   
              if (!primaryFunctionCall) {                                                                                                            
                primaryFunctionCall = functionCall;                                                                                                  
              }                                                                                                                                      
                                                                                                                                                     
              this.logger.info('Executing function', { functionName: functionCall.name });                                                           
              const functionResult = await onFunctionCall(functionCall);                                                                             
                                                                                                                                                     
              // Adicionar resultado desta tool call                                                                                                 
              messages.push({                                                                                                                        
                role: 'tool',                                                                                                                        
                tool_call_id: toolCall.id,                                                                                                           
                content: JSON.stringify(functionResult),                                                                                             
              });                                                                                                                                    
            }                                                                                                                                        
                                                                                                                                                     
            // Continuar a conversa                                                                                                                  
            const continuedResponse = await this.client.chat.completions.create({                                                                    
              model: this.model,                                                                                                                     
              messages,                                                                                                                              
              max_tokens: maxTokens,                                                                                                                 
              temperature,                                                                                                                           
            });                                                                                                                                      
                                                                                                                                                     
            const continuedChoice = continuedResponse.choices[0];                                                                                    
            return {                                                                                                                                 
              text: continuedChoice?.message?.content || '',                                                                                         
              functionCall: primaryFunctionCall,                                                                                                     
              finishReason: continuedChoice?.finish_reason || undefined,                                                                             
              tokensUsed: continuedResponse.usage ? {                                                                                                
                input: continuedResponse.usage.prompt_tokens,                                                                                        
                output: continuedResponse.usage.completion_tokens,                                                                                   
              } : undefined,                                                                                                                         
            };                                                                                                                                       
          }                                                                                                                                          
                                                                                                                                                     
          // Se não tem callback, retornar primeira function call                                                                                    
          const toolCall = allToolCalls[0];                                                                                                          
          const functionCall: OpenAIFunctionCall = {                                                                                                 
            name: toolCall.function.name,                                                                                                            
            args: JSON.parse(toolCall.function.arguments || '{}'),                                                                                   
          };                                                                                                                                         
                                                                                                                                                     
          // Se nao tem callback, retornar com function call                                                                                         
          return {                                                                                                                                   
            text: assistantMessage.content || '',                                                                                                    
            functionCall,                                                                                                                            
            finishReason: choice?.finish_reason || undefined,                                                                                        
            tokensUsed: response.usage ? {                                                                                                           
              input: response.usage.prompt_tokens,                                                                                                   
              output: response.usage.completion_tokens,                                                                                              
            } : undefined,                                                                                                                           
          };                                                                                                                                         
        }                                                                                                                                            
                                                                                                                                                     
        // Sem tool call - resposta normal                                                                                                           
        return {                                                                                                                                     
          text: assistantMessage?.content || '',                                                                                                     
          finishReason: choice?.finish_reason || undefined,                                                                                          
          tokensUsed: response.usage ? {                                                                                                             
            input: response.usage.prompt_tokens,                                                                                                     
            output: response.usage.completion_tokens,                                                                                                
          } : undefined,                                                                                                                             
        };                                                                                                                                           
      });                                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    // ========================================================================                                                                      
    // RETRY LOGIC                                                                                                                                   
    // ========================================================================                                                                      
                                                                                                                                                     
    private async executeWithRetry<T>(                                                                                                               
      operation: () => Promise<T>,                                                                                                                   
      retries: number = MAX_RETRIES                                                                                                                  
    ): Promise<T> {                                                                                                                                  
      let lastError: Error | null = null;                                                                                                            
                                                                                                                                                     
      for (let attempt = 1; attempt <= retries; attempt++) {                                                                                         
        try {                                                                                                                                        
          return await operation();                                                                                                                  
        } catch (error) {                                                                                                                            
          lastError = error instanceof Error ? error : new Error(String(error));                                                                     
                                                                                                                                                     
          // Verificar se e erro de quota/rate limit                                                                                                 
          if (error instanceof OpenAI.APIError) {                                                                                                    
            if (error.status === 429) {                                                                                                              
              this.logger.warn(`Rate limited, attempt ${attempt}/${retries}`, { message: error.message });                                           
                                                                                                                                                     
              if (attempt < retries) {                                                                                                               
                const delay = INITIAL_RETRY_DELAY_MS * Math.pow(2, attempt - 1);                                                                     
                await this.delay(delay);                                                                                                             
                continue;                                                                                                                            
              }                                                                                                                                      
            }                                                                                                                                        
                                                                                                                                                     
            // Erros de servidor                                                                                                                     
            if (error.status && error.status >= 500 && attempt < retries) {                                                                          
              const delay = INITIAL_RETRY_DELAY_MS * Math.pow(2, attempt - 1);                                                                       
              await this.delay(delay);                                                                                                               
              continue;                                                                                                                              
            }                                                                                                                                        
          }                                                                                                                                          
                                                                                                                                                     
          // Erro nao recuperavel ou ultima tentativa                                                                                                
          break;                                                                                                                                     
        }                                                                                                                                            
      }                                                                                                                                              
                                                                                                                                                     
      this.logger.error('All retry attempts failed', lastError);                                                                                     
      throw lastError;                                                                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    private delay(ms: number): Promise<void> {                                                                                                       
      return new Promise(resolve => setTimeout(resolve, ms));                                                                                        
    }                                                                                                                                                
                                                                                                                                                     
    // ========================================================================                                                                      
    // UTILITY METHODS                                                                                                                               
    // ========================================================================                                                                      
                                                                                                                                                     
    setModel(model: string): void {                                                                                                                  
      this.model = model;                                                                                                                            
      this.logger.info('Model updated', { model });                                                                                                  
    }                                                                                                                                                
                                                                                                                                                     
    getModel(): string {                                                                                                                             
      return this.model;                                                                                                                             
    }                                                                                                                                                
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // FACTORY                                                                                                                                         
  // ============================================================================                                                                    
                                                                                                                                                     
  export function createOpenAIClient(config: OpenAIConfig): OpenAIClient {                                                                           
    return new OpenAIClient(config);                                                                                                                 
  }                                                                                                                                                  
                                                                                                                                                     
  ---                                                                                                                                                
  Parte 35: services/ai/gemini-client.ts (874 linhas)                                                                                                
                                                                                                                                                     
  import { GoogleGenerativeAI, FunctionDeclaration, SchemaType, Tool as GeminiTool, FunctionCallingMode as GeminiFunctionCallingMode } from          
  '@google/generative-ai';                                                                                                                           
                                                                                                                                                     
  // ============================================================================                                                                    
  // LOGGER                                                                                                                                          
  // ============================================================================                                                                    
                                                                                                                                                     
  interface Logger {                                                                                                                                 
    debug(message: string, data?: unknown): void;                                                                                                    
    info(message: string, data?: unknown): void;                                                                                                     
    warn(message: string, data?: unknown): void;                                                                                                     
    error(message: string, data?: unknown): void;                                                                                                    
  }                                                                                                                                                  
                                                                                                                                                     
  function createLogger(name: string): Logger {                                                                                                      
    return {                                                                                                                                         
      debug: (msg, data) => console.debug(`[${name}] ${msg}`, data ?? ''),                                                                           
      info: (msg, data) => console.info(`[${name}] ${msg}`, data ?? ''),                                                                             
      warn: (msg, data) => console.warn(`[${name}] ${msg}`, data ?? ''),                                                                             
      error: (msg, data) => console.error(`[${name}] ${msg}`, data ?? ''),                                                                           
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // GEMINI TYPES                                                                                                                                    
  // ============================================================================                                                                    
                                                                                                                                                     
  export interface GeminiConfig {                                                                                                                    
    apiKey: string;                                                                                                                                  
    model?: string;                                                                                                                                  
  }                                                                                                                                                  
                                                                                                                                                     
  export interface GeminiMessage {                                                                                                                   
    role: 'user' | 'model';                                                                                                                          
    parts: { text: string }[];                                                                                                                       
  }                                                                                                                                                  
                                                                                                                                                     
  export interface GeminiChatOptions {                                                                                                               
    systemPrompt?: string;                                                                                                                           
    history?: GeminiMessage[];                                                                                                                       
    message: string;                                                                                                                                 
    maxTokens?: number;                                                                                                                              
    temperature?: number;                                                                                                                            
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // FUNCTION CALLING TYPES                                                                                                                          
  // ============================================================================                                                                    
                                                                                                                                                     
  export interface GeminiFunctionDeclarationInput {                                                                                                  
    name: string;                                                                                                                                    
    description: string;                                                                                                                             
    parameters: {                                                                                                                                    
      type: 'object';                                                                                                                                
      properties: Record<string, {                                                                                                                   
        type: string;                                                                                                                                
        description?: string;                                                                                                                        
        enum?: string[];                                                                                                                             
      }>;                                                                                                                                            
      required?: string[];                                                                                                                           
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Converte nossa definição de função para o formato do SDK Gemini                                                                                 
   */                                                                                                                                                
  function toGeminiFunctionDeclaration(input: GeminiFunctionDeclarationInput): FunctionDeclaration {                                                 
    const properties: Record<string, any> = {};                                                                                                      
                                                                                                                                                     
    for (const [key, value] of Object.entries(input.parameters.properties)) {                                                                        
      properties[key] = {                                                                                                                            
        type: mapTypeToSchemaType(value.type),                                                                                                       
        description: value.description,                                                                                                              
        enum: value.enum,                                                                                                                            
      };                                                                                                                                             
    }                                                                                                                                                
                                                                                                                                                     
    return {                                                                                                                                         
      name: input.name,                                                                                                                              
      description: input.description,                                                                                                                
      parameters: {                                                                                                                                  
        type: SchemaType.OBJECT,                                                                                                                     
        properties,                                                                                                                                  
        required: input.parameters.required,                                                                                                         
      },                                                                                                                                             
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Mapeia string de tipo para SchemaType                                                                                                           
   */                                                                                                                                                
  function mapTypeToSchemaType(type: string): SchemaType {                                                                                           
    switch (type.toLowerCase()) {                                                                                                                    
      case 'string':                                                                                                                                 
        return SchemaType.STRING;                                                                                                                    
      case 'number':                                                                                                                                 
        return SchemaType.NUMBER;                                                                                                                    
      case 'integer':                                                                                                                                
        return SchemaType.INTEGER;                                                                                                                   
      case 'boolean':                                                                                                                                
        return SchemaType.BOOLEAN;                                                                                                                   
      case 'array':                                                                                                                                  
        return SchemaType.ARRAY;                                                                                                                     
      case 'object':                                                                                                                                 
        return SchemaType.OBJECT;                                                                                                                    
      default:                                                                                                                                       
        return SchemaType.STRING;                                                                                                                    
    }                                                                                                                                                
  }                                                                                                                                                  
                                                                                                                                                     
  export interface GeminiFunctionCall {                                                                                                              
    name: string;                                                                                                                                    
    args: Record<string, unknown>;                                                                                                                   
  }                                                                                                                                                  
                                                                                                                                                     
  export interface GeminiFunctionResponse {                                                                                                          
    name: string;                                                                                                                                    
    response: Record<string, unknown>;                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  export type FunctionCallingMode = 'AUTO' | 'ANY' | 'NONE';                                                                                         
                                                                                                                                                     
  /**                                                                                                                                                
   * Converte string mode para enum do SDK Gemini                                                                                                    
   */                                                                                                                                                
  function toGeminiFunctionCallingMode(mode: FunctionCallingMode): GeminiFunctionCallingMode {                                                       
    switch (mode) {                                                                                                                                  
      case 'AUTO':                                                                                                                                   
        return GeminiFunctionCallingMode.AUTO;                                                                                                       
      case 'ANY':                                                                                                                                    
        return GeminiFunctionCallingMode.ANY;                                                                                                        
      case 'NONE':                                                                                                                                   
        return GeminiFunctionCallingMode.NONE;                                                                                                       
      default:                                                                                                                                       
        return GeminiFunctionCallingMode.AUTO;                                                                                                       
    }                                                                                                                                                
  }                                                                                                                                                  
                                                                                                                                                     
  export interface GeminiChatWithToolsOptions extends GeminiChatOptions {                                                                            
    tools?: GeminiFunctionDeclarationInput[];                                                                                                        
    onFunctionCall?: (functionCall: GeminiFunctionCall) => Promise<Record<string, unknown>>;                                                         
    functionCallingMode?: FunctionCallingMode;                                                                                                       
    allowedFunctions?: string[];                                                                                                                     
  }                                                                                                                                                  
                                                                                                                                                     
  export interface GeminiResponseWithTools extends GeminiResponse {                                                                                  
    functionCall?: GeminiFunctionCall;                                                                                                               
    finishReason?: string;                                                                                                                           
  }                                                                                                                                                  
                                                                                                                                                     
  export interface GeminiResponse {                                                                                                                  
    text: string;                                                                                                                                    
    tokensUsed?: {                                                                                                                                   
      input: number;                                                                                                                                 
      output: number;                                                                                                                                
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  export interface GeminiStreamOptions extends GeminiChatOptions {                                                                                   
    onChunk?: (chunk: string) => void;                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // CONSTANTS                                                                                                                                       
  // ============================================================================                                                                    
                                                                                                                                                     
  const DEFAULT_MODEL = 'gemini-2.0-flash';                                                                                                          
  const MAX_RETRIES = 3;                                                                                                                             
  const INITIAL_RETRY_DELAY_MS = 1000;                                                                                                               
                                                                                                                                                     
  // Mapeamento de modelos descontinuados/problematicos para modelos estaveis                                                                        
  const DEPRECATED_MODEL_MAPPING: Record<string, string> = {                                                                                         
    'gemini-1.5-pro': 'gemini-2.0-flash',                                                                                                            
    'gemini-1.5-pro-latest': 'gemini-2.0-flash',                                                                                                     
    'gemini-1.5-flash': 'gemini-2.0-flash',                                                                                                          
    'gemini-1.5-flash-latest': 'gemini-2.0-flash',                                                                                                   
    'gemini-1.0-pro': 'gemini-2.0-flash',                                                                                                            
    'gemini-pro': 'gemini-2.0-flash',                                                                                                                
    'gemini-pro-vision': 'gemini-2.0-flash',                                                                                                         
    'gemini-2.5-pro': 'gemini-2.0-flash', // 2.5-pro tendo problemas, usar 2.0-flash                                                                 
  };                                                                                                                                                 
                                                                                                                                                     
  function migrateModel(model: string): string {                                                                                                     
    if (DEPRECATED_MODEL_MAPPING[model]) {                                                                                                           
      console.warn(`[GeminiClient] Model ${model} is deprecated, migrating to ${DEPRECATED_MODEL_MAPPING[model]}`);                                  
      return DEPRECATED_MODEL_MAPPING[model];                                                                                                        
    }                                                                                                                                                
    return model;                                                                                                                                    
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // GEMINI CLIENT                                                                                                                                   
  // ============================================================================                                                                    
                                                                                                                                                     
  export class GeminiClient {                                                                                                                        
    private genAI: GoogleGenerativeAI;                                                                                                               
    private model: string;                                                                                                                           
    private logger: Logger;                                                                                                                          
                                                                                                                                                     
    constructor(config: GeminiConfig) {                                                                                                              
      if (!config.apiKey) {                                                                                                                          
        throw new Error('GeminiClient: apiKey is required');                                                                                         
      }                                                                                                                                              
                                                                                                                                                     
      this.genAI = new GoogleGenerativeAI(config.apiKey);                                                                                            
      this.model = migrateModel(config.model || DEFAULT_MODEL);                                                                                      
      this.logger = createLogger('GeminiClient');                                                                                                    
                                                                                                                                                     
      this.logger.info('Client initialized', { model: this.model });                                                                                 
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Envia uma mensagem em formato de chat                                                                                                         
     */                                                                                                                                              
    async chat(options: GeminiChatOptions): Promise<GeminiResponse> {                                                                                
      const { systemPrompt, history, message, maxTokens, temperature } = options;                                                                    
                                                                                                                                                     
      this.logger.debug('Starting chat', {                                                                                                           
        hasSystemPrompt: !!systemPrompt,                                                                                                             
        historyLength: history?.length || 0,                                                                                                         
        messageLength: message.length,                                                                                                               
      });                                                                                                                                            
                                                                                                                                                     
      return this.retryWithBackoff(async () => {                                                                                                     
        try {                                                                                                                                        
          // Configurar modelo                                                                                                                       
          const modelConfig: {                                                                                                                       
            model: string;                                                                                                                           
            systemInstruction?: string;                                                                                                              
            generationConfig?: {                                                                                                                     
              maxOutputTokens?: number;                                                                                                              
              temperature?: number;                                                                                                                  
            };                                                                                                                                       
          } = {                                                                                                                                      
            model: this.model,                                                                                                                       
          };                                                                                                                                         
                                                                                                                                                     
          // Adicionar system instruction se fornecido                                                                                               
          if (systemPrompt) {                                                                                                                        
            modelConfig.systemInstruction = systemPrompt;                                                                                            
          }                                                                                                                                          
                                                                                                                                                     
          // Adicionar generation config se fornecidos                                                                                               
          if (maxTokens || temperature !== undefined) {                                                                                              
            modelConfig.generationConfig = {};                                                                                                       
            if (maxTokens) {                                                                                                                         
              modelConfig.generationConfig.maxOutputTokens = maxTokens;                                                                              
            }                                                                                                                                        
            if (temperature !== undefined) {                                                                                                         
              modelConfig.generationConfig.temperature = temperature;                                                                                
            }                                                                                                                                        
          }                                                                                                                                          
                                                                                                                                                     
          const generativeModel = this.genAI.getGenerativeModel(modelConfig);                                                                        
                                                                                                                                                     
          // Iniciar chat com historico                                                                                                              
          const formattedHistory = history || [];                                                                                                    
          const chat = generativeModel.startChat({                                                                                                   
            history: formattedHistory,                                                                                                               
          });                                                                                                                                        
                                                                                                                                                     
          // Enviar mensagem                                                                                                                         
          const result = await chat.sendMessage(message);                                                                                            
          const response = result.response;                                                                                                          
                                                                                                                                                     
          // Extrair texto                                                                                                                           
          const text = response.text();                                                                                                              
                                                                                                                                                     
          // Extrair tokens usados                                                                                                                   
          const tokensUsed = response.usageMetadata                                                                                                  
            ? {                                                                                                                                      
                input: response.usageMetadata.promptTokenCount || 0,                                                                                 
                output: response.usageMetadata.candidatesTokenCount || 0,                                                                            
              }                                                                                                                                      
            : undefined;                                                                                                                             
                                                                                                                                                     
          this.logger.info('Chat completed', {                                                                                                       
            responseLength: text.length,                                                                                                             
            tokensUsed,                                                                                                                              
          });                                                                                                                                        
                                                                                                                                                     
          return { text, tokensUsed };                                                                                                               
                                                                                                                                                     
        } catch (error) {                                                                                                                            
          this.logger.error('Chat failed', {                                                                                                         
            error: error instanceof Error ? error.message : error,                                                                                   
          });                                                                                                                                        
          throw error;                                                                                                                               
        }                                                                                                                                            
      });                                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Envia uma mensagem com suporte a function calling                                                                                             
     * Executa automaticamente as funções e retorna a resposta final                                                                                 
     */                                                                                                                                              
    async chatWithTools(options: GeminiChatWithToolsOptions): Promise<GeminiResponseWithTools> {                                                     
      const { systemPrompt, history, message, maxTokens, temperature, tools, onFunctionCall, functionCallingMode, allowedFunctions } = options;      
                                                                                                                                                     
      this.logger.debug('Starting chat with tools', {                                                                                                
        hasSystemPrompt: !!systemPrompt,                                                                                                             
        historyLength: history?.length || 0,                                                                                                         
        messageLength: message.length,                                                                                                               
        toolsCount: tools?.length || 0,                                                                                                              
        functionCallingMode: functionCallingMode || 'AUTO',                                                                                          
      });                                                                                                                                            
                                                                                                                                                     
      return this.retryWithBackoff(async () => {                                                                                                     
        try {                                                                                                                                        
          // Configurar modelo com tools                                                                                                             
          const modelConfig: {                                                                                                                       
            model: string;                                                                                                                           
            systemInstruction?: string;                                                                                                              
            generationConfig?: {                                                                                                                     
              maxOutputTokens?: number;                                                                                                              
              temperature?: number;                                                                                                                  
            };                                                                                                                                       
            tools?: GeminiTool[];                                                                                                                    
            toolConfig?: {                                                                                                                           
              functionCallingConfig: {                                                                                                               
                mode: GeminiFunctionCallingMode;                                                                                                     
                allowedFunctionNames?: string[];                                                                                                     
              };                                                                                                                                     
            };                                                                                                                                       
          } = {                                                                                                                                      
            model: this.model,                                                                                                                       
          };                                                                                                                                         
                                                                                                                                                     
          if (systemPrompt) {                                                                                                                        
            modelConfig.systemInstruction = systemPrompt;                                                                                            
          }                                                                                                                                          
                                                                                                                                                     
          if (maxTokens || temperature !== undefined) {                                                                                              
            modelConfig.generationConfig = {};                                                                                                       
            if (maxTokens) {                                                                                                                         
              modelConfig.generationConfig.maxOutputTokens = maxTokens;                                                                              
            }                                                                                                                                        
            if (temperature !== undefined) {                                                                                                         
              modelConfig.generationConfig.temperature = temperature;                                                                                
            }                                                                                                                                        
          }                                                                                                                                          
                                                                                                                                                     
          // Adicionar tools se fornecidas                                                                                                           
          if (tools && tools.length > 0) {                                                                                                           
            const geminiTools: GeminiTool[] = [{                                                                                                     
              functionDeclarations: tools.map(toGeminiFunctionDeclaration),                                                                          
            }];                                                                                                                                      
            modelConfig.tools = geminiTools;                                                                                                         
                                                                                                                                                     
            // Adicionar toolConfig se especificado                                                                                                  
            if (functionCallingMode) {                                                                                                               
              modelConfig.toolConfig = {                                                                                                             
                functionCallingConfig: {                                                                                                             
                  mode: toGeminiFunctionCallingMode(functionCallingMode),                                                                            
                },                                                                                                                                   
              };                                                                                                                                     
                                                                                                                                                     
              // Adicionar funções permitidas se modo é ANY e foram especificadas                                                                    
              if (functionCallingMode === 'ANY' && allowedFunctions && allowedFunctions.length > 0) {                                                
                modelConfig.toolConfig.functionCallingConfig.allowedFunctionNames = allowedFunctions;                                                
              }                                                                                                                                      
            }                                                                                                                                        
          }                                                                                                                                          
                                                                                                                                                     
          this.logger.debug('Model config', {                                                                                                        
            hasTools: !!modelConfig.tools,                                                                                                           
            hasToolConfig: !!modelConfig.toolConfig,                                                                                                 
            toolConfig: modelConfig.toolConfig,                                                                                                      
          });                                                                                                                                        
                                                                                                                                                     
          const generativeModel = this.genAI.getGenerativeModel(modelConfig);                                                                        
                                                                                                                                                     
          // Iniciar chat com historico                                                                                                              
          // IMPORTANTE: Gemini exige que primeira mensagem seja do 'user'                                                                           
          let formattedHistory = history || [];                                                                                                      
          if (formattedHistory.length > 0 && formattedHistory[0].role === 'model') {                                                                 
            this.logger.info('History starts with model, adding user placeholder');                                                                  
            formattedHistory = [                                                                                                                     
              { role: 'user' as const, parts: [{ text: '[Início da conversa]' }] },                                                                  
              ...formattedHistory,                                                                                                                   
            ];                                                                                                                                       
          }                                                                                                                                          
                                                                                                                                                     
          const chat = generativeModel.startChat({                                                                                                   
            history: formattedHistory,                                                                                                               
          });                                                                                                                                        
                                                                                                                                                     
          // Enviar mensagem inicial                                                                                                                 
          let result = await chat.sendMessage(message);                                                                                              
          let response = result.response;                                                                                                            
                                                                                                                                                     
          // Loop de processamento de function calls                                                                                                 
          let maxIterations = 5; // Limite de segurança                                                                                              
          let iteration = 0;                                                                                                                         
                                                                                                                                                     
          while (iteration < maxIterations) {                                                                                                        
            iteration++;                                                                                                                             
                                                                                                                                                     
            // Verificar se há function calls na resposta                                                                                            
            const candidate = response.candidates?.[0];                                                                                              
            const parts = candidate?.content?.parts || [];                                                                                           
                                                                                                                                                     
            // Coletar TODAS as function calls (Gemini 2.0 pode retornar múltiplas)                                                                  
            const functionCallParts: Array<{ functionCall: GeminiFunctionCall }> = [];                                                               
            for (const part of parts) {                                                                                                              
              if ((part as any).functionCall) {                                                                                                      
                functionCallParts.push(part as any);                                                                                                 
              }                                                                                                                                      
            }                                                                                                                                        
                                                                                                                                                     
            if (functionCallParts.length > 0) {                                                                                                      
              this.logger.info('Function calls detected', {                                                                                          
                count: functionCallParts.length,                                                                                                     
                names: functionCallParts.map(p => p.functionCall.name),                                                                              
                iteration,                                                                                                                           
              });                                                                                                                                    
                                                                                                                                                     
              // Se não temos handler, retornar a primeira function call para processamento externo                                                  
              if (!onFunctionCall) {                                                                                                                 
                this.logger.debug('No onFunctionCall handler, returning first function call');                                                       
                return {                                                                                                                             
                  text: '',                                                                                                                          
                  functionCall: functionCallParts[0].functionCall,                                                                                   
                  finishReason: 'function_call',                                                                                                     
                  tokensUsed: response.usageMetadata                                                                                                 
                    ? {                                                                                                                              
                        input: response.usageMetadata.promptTokenCount || 0,                                                                         
                        output: response.usageMetadata.candidatesTokenCount || 0,                                                                    
                      }                                                                                                                              
                    : undefined,                                                                                                                     
                };                                                                                                                                   
              }                                                                                                                                      
                                                                                                                                                     
              // Executar TODAS as funções e coletar resultados                                                                                      
              const functionResponses: Array<{ functionResponse: { name: string; response: Record<string, unknown> } }> = [];                        
                                                                                                                                                     
              for (const functionCallPart of functionCallParts) {                                                                                    
                const functionCall = functionCallPart.functionCall;                                                                                  
                                                                                                                                                     
                this.logger.debug('Executing function', { name: functionCall.name });                                                                
                const functionResult = await onFunctionCall(functionCall);                                                                           
                                                                                                                                                     
                this.logger.debug('Function result', {                                                                                               
                  name: functionCall.name,                                                                                                           
                  resultKeys: Object.keys(functionResult),                                                                                           
                });                                                                                                                                  
                                                                                                                                                     
                functionResponses.push({                                                                                                             
                  functionResponse: {                                                                                                                
                    name: functionCall.name,                                                                                                         
                    response: functionResult,                                                                                                        
                  },                                                                                                                                 
                });                                                                                                                                  
              }                                                                                                                                      
                                                                                                                                                     
              // Após executar as funções, precisamos enviar os resultados                                                                           
              // Se estávamos no modo ANY, criar novo modelo sem forçar função para permitir resposta em texto                                       
              if (functionCallingMode === 'ANY' && iteration === 1) {                                                                                
                this.logger.debug('Switching from ANY mode to AUTO for response generation');                                                        
                                                                                                                                                     
                // Criar modelo sem toolConfig para permitir resposta em texto                                                                       
                const responseModelConfig: {                                                                                                         
                  model: string;                                                                                                                     
                  systemInstruction?: string;                                                                                                        
                  generationConfig?: {                                                                                                               
                    maxOutputTokens?: number;                                                                                                        
                    temperature?: number;                                                                                                            
                  };                                                                                                                                 
                  tools?: GeminiTool[];                                                                                                              
                } = {                                                                                                                                
                  model: this.model,                                                                                                                 
                };                                                                                                                                   
                                                                                                                                                     
                if (systemPrompt) {                                                                                                                  
                  responseModelConfig.systemInstruction = systemPrompt;                                                                              
                }                                                                                                                                    
                                                                                                                                                     
                if (maxTokens || temperature !== undefined) {                                                                                        
                  responseModelConfig.generationConfig = {};                                                                                         
                  if (maxTokens) {                                                                                                                   
                    responseModelConfig.generationConfig.maxOutputTokens = maxTokens;                                                                
                  }                                                                                                                                  
                  if (temperature !== undefined) {                                                                                                   
                    responseModelConfig.generationConfig.temperature = temperature;                                                                  
                  }                                                                                                                                  
                }                                                                                                                                    
                                                                                                                                                     
                // Manter tools mas sem forçar chamada (modo AUTO implícito)                                                                         
                if (tools && tools.length > 0) {                                                                                                     
                  responseModelConfig.tools = [{                                                                                                     
                    functionDeclarations: tools.map(toGeminiFunctionDeclaration),                                                                    
                  }];                                                                                                                                
                }                                                                                                                                    
                                                                                                                                                     
                const responseModel = this.genAI.getGenerativeModel(responseModelConfig);                                                            
                                                                                                                                                     
                // Reconstruir histórico incluindo TODAS as chamadas de função                                                                       
                const functionCallHistoryParts = functionCallParts.map(p => ({                                                                       
                  functionCall: { name: p.functionCall.name, args: p.functionCall.args }                                                             
                }));                                                                                                                                 
                                                                                                                                                     
                const fullHistory = [                                                                                                                
                  ...formattedHistory,                                                                                                               
                  { role: 'user' as const, parts: [{ text: message }] },                                                                             
                  { role: 'model' as const, parts: functionCallHistoryParts },                                                                       
                ];                                                                                                                                   
                                                                                                                                                     
                const responseChat = responseModel.startChat({                                                                                       
                  history: fullHistory,                                                                                                              
                });                                                                                                                                  
                                                                                                                                                     
                // Enviar TODOS os resultados das funções                                                                                            
                result = await responseChat.sendMessage(functionResponses as any);                                                                   
                response = result.response;                                                                                                          
              } else {                                                                                                                               
                // Modo normal - enviar TODOS os resultados das funções de volta para o modelo                                                       
                result = await chat.sendMessage(functionResponses as any);                                                                           
                response = result.response;                                                                                                          
              }                                                                                                                                      
            } else {                                                                                                                                 
              // Não há mais function calls, extrair texto                                                                                           
              break;                                                                                                                                 
            }                                                                                                                                        
          }                                                                                                                                          
                                                                                                                                                     
          // Extrair texto da resposta final                                                                                                         
          const text = response.text();                                                                                                              
                                                                                                                                                     
          const tokensUsed = response.usageMetadata                                                                                                  
            ? {                                                                                                                                      
                input: response.usageMetadata.promptTokenCount || 0,                                                                                 
                output: response.usageMetadata.candidatesTokenCount || 0,                                                                            
              }                                                                                                                                      
            : undefined;                                                                                                                             
                                                                                                                                                     
          this.logger.info('Chat with tools completed', {                                                                                            
            responseLength: text.length,                                                                                                             
            tokensUsed,                                                                                                                              
            iterations: iteration,                                                                                                                   
          });                                                                                                                                        
                                                                                                                                                     
          return {                                                                                                                                   
            text,                                                                                                                                    
            tokensUsed,                                                                                                                              
            finishReason: 'stop',                                                                                                                    
          };                                                                                                                                         
                                                                                                                                                     
        } catch (error) {                                                                                                                            
          this.logger.error('Chat with tools failed', {                                                                                              
            error: error instanceof Error ? error.message : error,                                                                                   
          });                                                                                                                                        
          throw error;                                                                                                                               
        }                                                                                                                                            
      });                                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Envia mensagem com streaming                                                                                                                  
     */                                                                                                                                              
    async chatStream(options: GeminiStreamOptions): Promise<GeminiResponse> {                                                                        
      const { systemPrompt, history, message, maxTokens, temperature, onChunk } = options;                                                           
                                                                                                                                                     
      this.logger.debug('Starting streaming chat', {                                                                                                 
        hasSystemPrompt: !!systemPrompt,                                                                                                             
        messageLength: message.length,                                                                                                               
      });                                                                                                                                            
                                                                                                                                                     
      return this.retryWithBackoff(async () => {                                                                                                     
        try {                                                                                                                                        
          const modelConfig: {                                                                                                                       
            model: string;                                                                                                                           
            systemInstruction?: string;                                                                                                              
            generationConfig?: {                                                                                                                     
              maxOutputTokens?: number;                                                                                                              
              temperature?: number;                                                                                                                  
            };                                                                                                                                       
          } = {                                                                                                                                      
            model: this.model,                                                                                                                       
          };                                                                                                                                         
                                                                                                                                                     
          if (systemPrompt) {                                                                                                                        
            modelConfig.systemInstruction = systemPrompt;                                                                                            
          }                                                                                                                                          
                                                                                                                                                     
          if (maxTokens || temperature !== undefined) {                                                                                              
            modelConfig.generationConfig = {};                                                                                                       
            if (maxTokens) {                                                                                                                         
              modelConfig.generationConfig.maxOutputTokens = maxTokens;                                                                              
            }                                                                                                                                        
            if (temperature !== undefined) {                                                                                                         
              modelConfig.generationConfig.temperature = temperature;                                                                                
            }                                                                                                                                        
          }                                                                                                                                          
                                                                                                                                                     
          const generativeModel = this.genAI.getGenerativeModel(modelConfig);                                                                        
          const chat = generativeModel.startChat({                                                                                                   
            history: history || [],                                                                                                                  
          });                                                                                                                                        
                                                                                                                                                     
          // Enviar com streaming                                                                                                                    
          const result = await chat.sendMessageStream(message);                                                                                      
                                                                                                                                                     
          let fullText = '';                                                                                                                         
          for await (const chunk of result.stream) {                                                                                                 
            const chunkText = chunk.text();                                                                                                          
            fullText += chunkText;                                                                                                                   
                                                                                                                                                     
            if (onChunk) {                                                                                                                           
              onChunk(chunkText);                                                                                                                    
            }                                                                                                                                        
          }                                                                                                                                          
                                                                                                                                                     
          // Obter resposta final para metadata                                                                                                      
          const finalResponse = await result.response;                                                                                               
          const tokensUsed = finalResponse.usageMetadata                                                                                             
            ? {                                                                                                                                      
                input: finalResponse.usageMetadata.promptTokenCount || 0,                                                                            
                output: finalResponse.usageMetadata.candidatesTokenCount || 0,                                                                       
              }                                                                                                                                      
            : undefined;                                                                                                                             
                                                                                                                                                     
          this.logger.info('Streaming chat completed', {                                                                                             
            responseLength: fullText.length,                                                                                                         
            tokensUsed,                                                                                                                              
          });                                                                                                                                        
                                                                                                                                                     
          return { text: fullText, tokensUsed };                                                                                                     
                                                                                                                                                     
        } catch (error) {                                                                                                                            
          this.logger.error('Streaming chat failed', {                                                                                               
            error: error instanceof Error ? error.message : error,                                                                                   
          });                                                                                                                                        
          throw error;                                                                                                                               
        }                                                                                                                                            
      });                                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Gera conteudo simples sem chat                                                                                                                
     */                                                                                                                                              
    async generateContent(prompt: string): Promise<string> {                                                                                         
      this.logger.debug('Generating content', { promptLength: prompt.length });                                                                      
                                                                                                                                                     
      return this.retryWithBackoff(async () => {                                                                                                     
        try {                                                                                                                                        
          const generativeModel = this.genAI.getGenerativeModel({                                                                                    
            model: this.model,                                                                                                                       
          });                                                                                                                                        
                                                                                                                                                     
          const result = await generativeModel.generateContent(prompt);                                                                              
          const text = result.response.text();                                                                                                       
                                                                                                                                                     
          this.logger.info('Content generated', { responseLength: text.length });                                                                    
                                                                                                                                                     
          return text;                                                                                                                               
                                                                                                                                                     
        } catch (error) {                                                                                                                            
          this.logger.error('Content generation failed', {                                                                                           
            error: error instanceof Error ? error.message : error,                                                                                   
          });                                                                                                                                        
          throw error;                                                                                                                               
        }                                                                                                                                            
      });                                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Gera conteudo com imagem (multimodal)                                                                                                         
     */                                                                                                                                              
    async generateContentWithImage(                                                                                                                  
      prompt: string,                                                                                                                                
      imageBase64: string,                                                                                                                           
      mimeType: string = 'image/jpeg'                                                                                                                
    ): Promise<string> {                                                                                                                             
      this.logger.debug('Generating content with image', {                                                                                           
        promptLength: prompt.length,                                                                                                                 
        mimeType,                                                                                                                                    
      });                                                                                                                                            
                                                                                                                                                     
      return this.retryWithBackoff(async () => {                                                                                                     
        try {                                                                                                                                        
          const generativeModel = this.genAI.getGenerativeModel({                                                                                    
            model: this.model,                                                                                                                       
          });                                                                                                                                        
                                                                                                                                                     
          const result = await generativeModel.generateContent([                                                                                     
            prompt,                                                                                                                                  
            {                                                                                                                                        
              inlineData: {                                                                                                                          
                mimeType,                                                                                                                            
                data: imageBase64,                                                                                                                   
              },                                                                                                                                     
            },                                                                                                                                       
          ]);                                                                                                                                        
                                                                                                                                                     
          const text = result.response.text();                                                                                                       
                                                                                                                                                     
          this.logger.info('Content with image generated', {                                                                                         
            responseLength: text.length,                                                                                                             
          });                                                                                                                                        
                                                                                                                                                     
          return text;                                                                                                                               
                                                                                                                                                     
        } catch (error) {                                                                                                                            
          this.logger.error('Content with image generation failed', {                                                                                
            error: error instanceof Error ? error.message : error,                                                                                   
          });                                                                                                                                        
          throw error;                                                                                                                               
        }                                                                                                                                            
      });                                                                                                                                            
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Converte historico para formato Gemini                                                                                                        
     */                                                                                                                                              
    formatHistory(messages: Array<{ role: string; content: string }>): GeminiMessage[] {                                                             
      return messages.map((msg) => ({                                                                                                                
        role: msg.role === 'assistant' || msg.role === 'model' ? 'model' : 'user',                                                                   
        parts: [{ text: msg.content }],                                                                                                              
      }));                                                                                                                                           
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Executa operacao com retry e backoff exponencial                                                                                              
     */                                                                                                                                              
    private async retryWithBackoff<T>(                                                                                                               
      fn: () => Promise<T>,                                                                                                                          
      maxRetries: number = MAX_RETRIES                                                                                                               
    ): Promise<T> {                                                                                                                                  
      let lastError: Error | null = null;                                                                                                            
                                                                                                                                                     
      for (let attempt = 1; attempt <= maxRetries; attempt++) {                                                                                      
        try {                                                                                                                                        
          return await fn();                                                                                                                         
        } catch (error) {                                                                                                                            
          lastError = error instanceof Error ? error : new Error(String(error));                                                                     
                                                                                                                                                     
          // Verificar se e erro retryable                                                                                                           
          if (!this.isRetryableError(error)) {                                                                                                       
            this.logger.error('Non-retryable error', { error: lastError.message });                                                                  
            throw lastError;                                                                                                                         
          }                                                                                                                                          
                                                                                                                                                     
          if (attempt < maxRetries) {                                                                                                                
            // Backoff exponencial: 1s, 2s, 4s                                                                                                       
            const delay = INITIAL_RETRY_DELAY_MS * Math.pow(2, attempt - 1);                                                                         
                                                                                                                                                     
            this.logger.warn(`Attempt ${attempt} failed, retrying in ${delay}ms`, {                                                                  
              error: lastError.message,                                                                                                              
            });                                                                                                                                      
                                                                                                                                                     
            await this.delay(delay);                                                                                                                 
          }                                                                                                                                          
        }                                                                                                                                            
      }                                                                                                                                              
                                                                                                                                                     
      this.logger.error('All retry attempts failed', { error: lastError?.message });                                                                 
      throw lastError;                                                                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Verifica se o erro e recuperavel (retry)                                                                                                      
     */                                                                                                                                              
    private isRetryableError(error: unknown): boolean {                                                                                              
      if (error instanceof Error) {                                                                                                                  
        const message = error.message.toLowerCase();                                                                                                 
                                                                                                                                                     
        // Erros de rate limit                                                                                                                       
        if (message.includes('429') || message.includes('rate limit') || message.includes('quota')) {                                                
          return true;                                                                                                                               
        }                                                                                                                                            
                                                                                                                                                     
        // Erros de servidor                                                                                                                         
        if (                                                                                                                                         
          message.includes('500') ||                                                                                                                 
          message.includes('502') ||                                                                                                                 
          message.includes('503') ||                                                                                                                 
          message.includes('504')                                                                                                                    
        ) {                                                                                                                                          
          return true;                                                                                                                               
        }                                                                                                                                            
                                                                                                                                                     
        // Erros de rede                                                                                                                             
        if (                                                                                                                                         
          message.includes('econnreset') ||                                                                                                          
          message.includes('etimedout') ||                                                                                                           
          message.includes('enotfound') ||                                                                                                           
          message.includes('socket hang up') ||                                                                                                      
          message.includes('network')                                                                                                                
        ) {                                                                                                                                          
          return true;                                                                                                                               
        }                                                                                                                                            
                                                                                                                                                     
        // Erro temporario do Gemini                                                                                                                 
        if (message.includes('temporarily unavailable') || message.includes('overloaded')) {                                                         
          return true;                                                                                                                               
        }                                                                                                                                            
      }                                                                                                                                              
                                                                                                                                                     
      return false;                                                                                                                                  
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Helper para delay                                                                                                                             
     */                                                                                                                                              
    private delay(ms: number): Promise<void> {                                                                                                       
      return new Promise((resolve) => setTimeout(resolve, ms));                                                                                      
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Atualiza o modelo usado                                                                                                                       
     */                                                                                                                                              
    setModel(model: string): void {                                                                                                                  
      this.model = model;                                                                                                                            
      this.logger.info('Model updated', { model });                                                                                                  
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Retorna o modelo atual                                                                                                                        
     */                                                                                                                                              
    getModel(): string {                                                                                                                             
      return this.model;                                                                                                                             
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Conta tokens de um texto (estimativa)                                                                                                         
     */                                                                                                                                              
    async countTokens(text: string): Promise<number> {                                                                                               
      try {                                                                                                                                          
        const generativeModel = this.genAI.getGenerativeModel({ model: this.model });                                                                
        const result = await generativeModel.countTokens(text);                                                                                      
        return result.totalTokens;                                                                                                                   
      } catch (error) {                                                                                                                              
        this.logger.warn('Token counting failed, using estimate', {                                                                                  
          error: error instanceof Error ? error.message : error,                                                                                     
        });                                                                                                                                          
        // Estimativa: ~4 caracteres por token                                                                                                       
        return Math.ceil(text.length / 4);                                                                                                           
      }                                                                                                                                              
    }                                                                                                                                                
                                                                                                                                                     
    /**                                                                                                                                              
     * Lista modelos disponiveis                                                                                                                     
     */                                                                                                                                              
    async listModels(): Promise<string[]> {                                                                                                          
      // Modelos Gemini atuais (janeiro 2026)                                                                                                        
      return [                                                                                                                                       
        'gemini-2.5-pro',                                                                                                                            
        'gemini-2.5-flash',                                                                                                                          
        'gemini-2.0-flash',                                                                                                                          
        'gemini-2.0-flash-exp',                                                                                                                      
      ];                                                                                                                                             
    }                                                                                                                                                
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // FACTORY FUNCTION                                                                                                                                
  // ============================================================================                                                                    
                                                                                                                                                     
  /**                                                                                                                                                
   * Factory function para criar cliente Gemini                                                                                                      
   */                                                                                                                                                
  export function createGeminiClient(config: GeminiConfig): GeminiClient {                                                                           
    return new GeminiClient(config);                                                                                                                 
  }                                                                                                                                                  
                                                                                                                                                     
  ---                                                                                                                                                
  Parte 36: services/ai/media-analyzer.ts (529 linhas)                                                                                               
                                                                                                                                                     
  /**                                                                                                                                                
   * Media Analyzer - Serviço de análise de mídia multi-provider                                                                                     
   * Suporta: OpenAI (Whisper + GPT-4 Vision), Gemini (Flash 2.0)                                                                                    
   */                                                                                                                                                
                                                                                                                                                     
  import OpenAI from 'openai';                                                                                                                       
  import { GoogleGenerativeAI } from '@google/generative-ai';                                                                                        
  import { AIProvider, Agent } from '../supabase/types';                                                                                             
                                                                                                                                                     
  // ============================================================================                                                                    
  // LOGGER                                                                                                                                          
  // ============================================================================                                                                    
                                                                                                                                                     
  interface Logger {                                                                                                                                 
    debug(message: string, data?: unknown): void;                                                                                                    
    info(message: string, data?: unknown): void;                                                                                                     
    warn(message: string, data?: unknown): void;                                                                                                     
    error(message: string, data?: unknown): void;                                                                                                    
  }                                                                                                                                                  
                                                                                                                                                     
  function createLogger(name: string): Logger {                                                                                                      
    return {                                                                                                                                         
      debug: (msg, data) => console.debug(`[${name}] ${msg}`, data ?? ''),                                                                           
      info: (msg, data) => console.info(`[${name}] ${msg}`, data ?? ''),                                                                             
      warn: (msg, data) => console.warn(`[${name}] ${msg}`, data ?? ''),                                                                             
      error: (msg, data) => console.error(`[${name}] ${msg}`, data ?? ''),                                                                           
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  const logger = createLogger('MediaAnalyzer');                                                                                                      
                                                                                                                                                     
  // ============================================================================                                                                    
  // TYPES                                                                                                                                           
  // ============================================================================                                                                    
                                                                                                                                                     
  export interface MediaAnalysisResult {                                                                                                             
    success: boolean;                                                                                                                                
    text: string;                                                                                                                                    
    type: 'transcription' | 'vision' | 'error';                                                                                                      
    provider: AIProvider;                                                                                                                            
    duration?: number;                                                                                                                               
    confidence?: number;                                                                                                                             
  }                                                                                                                                                  
                                                                                                                                                     
  export interface MediaData {                                                                                                                       
    base64: string;                                                                                                                                  
    mimeType: string;                                                                                                                                
    messageId?: string;                                                                                                                              
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // AUDIO TRANSCRIPTION                                                                                                                             
  // ============================================================================                                                                    
                                                                                                                                                     
  /**                                                                                                                                                
   * Transcreve áudio usando o provider configurado do agent                                                                                         
   */                                                                                                                                                
  export async function transcribeAudio(                                                                                                             
    agent: Agent,                                                                                                                                    
    mediaData: MediaData                                                                                                                             
  ): Promise<MediaAnalysisResult> {                                                                                                                  
    const provider = agent.ai_provider || 'gemini';                                                                                                  
                                                                                                                                                     
    logger.info('Transcribing audio', {                                                                                                              
      provider,                                                                                                                                      
      mimeType: mediaData.mimeType,                                                                                                                  
      hasBase64: !!mediaData.base64                                                                                                                  
    });                                                                                                                                              
                                                                                                                                                     
    try {                                                                                                                                            
      switch (provider) {                                                                                                                            
        case 'openai':                                                                                                                               
          return await transcribeWithOpenAI(agent, mediaData);                                                                                       
        case 'gemini':                                                                                                                               
          return await transcribeWithGemini(agent, mediaData);                                                                                       
        case 'claude':                                                                                                                               
          // Claude não tem transcrição nativa, fallback para descrição                                                                              
          return await describeAudioWithClaude(agent, mediaData);                                                                                    
        default:                                                                                                                                     
          return await transcribeWithGemini(agent, mediaData);                                                                                       
      }                                                                                                                                              
    } catch (error) {                                                                                                                                
      const errorMessage = error instanceof Error ? error.message : String(error);                                                                   
      logger.error('Transcription failed', { provider, error: errorMessage });                                                                       
                                                                                                                                                     
      return {                                                                                                                                       
        success: false,                                                                                                                              
        text: '[Não foi possível transcrever o áudio]',                                                                                              
        type: 'error',                                                                                                                               
        provider,                                                                                                                                    
      };                                                                                                                                             
    }                                                                                                                                                
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Transcreve áudio usando OpenAI Whisper                                                                                                          
   */                                                                                                                                                
  async function transcribeWithOpenAI(                                                                                                               
    agent: Agent,                                                                                                                                    
    mediaData: MediaData                                                                                                                             
  ): Promise<MediaAnalysisResult> {                                                                                                                  
    const apiKey = (agent as any).openai_api_key;                                                                                                    
                                                                                                                                                     
    if (!apiKey) {                                                                                                                                   
      throw new Error('OpenAI API key not configured for this agent');                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    const client = new OpenAI({ apiKey });                                                                                                           
                                                                                                                                                     
    // Converter base64 para Buffer e criar arquivo usando toFile do SDK                                                                             
    const base64Clean = cleanBase64Data(mediaData.base64);                                                                                           
    const buffer = Buffer.from(base64Clean, 'base64');                                                                                               
    const extension = getAudioExtension(mediaData.mimeType);                                                                                         
    const filename = `audio.${extension}`;                                                                                                           
                                                                                                                                                     
    logger.debug('Calling OpenAI Whisper', { extension, mimeType: mediaData.mimeType, bufferSize: buffer.length });                                  
                                                                                                                                                     
    // Usar toFile do SDK do OpenAI para criar um arquivo compatível com Node.js                                                                     
    const file = await OpenAI.toFile(buffer, filename, { type: mediaData.mimeType });                                                                
                                                                                                                                                     
    const response = await client.audio.transcriptions.create({                                                                                      
      file,                                                                                                                                          
      model: 'whisper-1',                                                                                                                            
      language: 'pt',                                                                                                                                
      response_format: 'verbose_json',                                                                                                               
    });                                                                                                                                              
                                                                                                                                                     
    logger.info('OpenAI transcription completed', {                                                                                                  
      textLength: response.text.length,                                                                                                              
      duration: response.duration                                                                                                                    
    });                                                                                                                                              
                                                                                                                                                     
    return {                                                                                                                                         
      success: true,                                                                                                                                 
      text: response.text,                                                                                                                           
      type: 'transcription',                                                                                                                         
      provider: 'openai',                                                                                                                            
      duration: response.duration,                                                                                                                   
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Transcreve áudio usando Gemini Flash 2.0                                                                                                        
   * Gemini 2.0 Flash suporta áudio nativamente                                                                                                      
   */                                                                                                                                                
  async function transcribeWithGemini(                                                                                                               
    agent: Agent,                                                                                                                                    
    mediaData: MediaData                                                                                                                             
  ): Promise<MediaAnalysisResult> {                                                                                                                  
    const apiKey = agent.gemini_api_key;                                                                                                             
                                                                                                                                                     
    if (!apiKey) {                                                                                                                                   
      throw new Error('Gemini API key not configured for this agent');                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    const genAI = new GoogleGenerativeAI(apiKey);                                                                                                    
    const model = genAI.getGenerativeModel({ model: 'gemini-2.0-flash-exp' });                                                                       
                                                                                                                                                     
    // Limpar base64 usando helper universal                                                                                                         
    const base64Clean = cleanBase64Data(mediaData.base64);                                                                                           
                                                                                                                                                     
    logger.debug('Calling Gemini for audio transcription', { mimeType: mediaData.mimeType });                                                        
                                                                                                                                                     
    const result = await model.generateContent([                                                                                                     
      {                                                                                                                                              
        inlineData: {                                                                                                                                
          mimeType: mediaData.mimeType,                                                                                                              
          data: base64Clean,                                                                                                                         
        },                                                                                                                                           
      },                                                                                                                                             
      'Transcreva este áudio em português. Retorne apenas a transcrição, sem comentários adicionais.',                                               
    ]);                                                                                                                                              
                                                                                                                                                     
    const text = result.response.text();                                                                                                             
                                                                                                                                                     
    logger.info('Gemini transcription completed', { textLength: text.length });                                                                      
                                                                                                                                                     
    return {                                                                                                                                         
      success: true,                                                                                                                                 
      text,                                                                                                                                          
      type: 'transcription',                                                                                                                         
      provider: 'gemini',                                                                                                                            
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Para Claude, tentamos fallback para Gemini ou OpenAI                                                                                            
   * Claude não tem transcrição nativa de áudio                                                                                                      
   */                                                                                                                                                
  async function describeAudioWithClaude(                                                                                                            
    agent: Agent,                                                                                                                                    
    mediaData: MediaData                                                                                                                             
  ): Promise<MediaAnalysisResult> {                                                                                                                  
    // Tentar fallback para Gemini primeiro (mais comum)                                                                                             
    if (agent.gemini_api_key) {                                                                                                                      
      logger.info('Claude does not support audio, falling back to Gemini');                                                                          
      try {                                                                                                                                          
        const result = await transcribeWithGemini(agent, mediaData);                                                                                 
        return {                                                                                                                                     
          ...result,                                                                                                                                 
          provider: 'claude', // Manter Claude como provider principal                                                                               
        };                                                                                                                                           
      } catch (error) {                                                                                                                              
        logger.warn('Gemini fallback failed', { error: error instanceof Error ? error.message : error });                                            
      }                                                                                                                                              
    }                                                                                                                                                
                                                                                                                                                     
    // Tentar fallback para OpenAI                                                                                                                   
    if ((agent as any).openai_api_key) {                                                                                                             
      logger.info('Claude does not support audio, falling back to OpenAI Whisper');                                                                  
      try {                                                                                                                                          
        const result = await transcribeWithOpenAI(agent, mediaData);                                                                                 
        return {                                                                                                                                     
          ...result,                                                                                                                                 
          provider: 'claude', // Manter Claude como provider principal                                                                               
        };                                                                                                                                           
      } catch (error) {                                                                                                                              
        logger.warn('OpenAI fallback failed', { error: error instanceof Error ? error.message : error });                                            
      }                                                                                                                                              
    }                                                                                                                                                
                                                                                                                                                     
    // Se nenhum fallback disponível, retornar mensagem informativa                                                                                  
    logger.warn('No fallback available for Claude audio transcription');                                                                             
    return {                                                                                                                                         
      success: false,                                                                                                                                
      text: '[Mensagem de áudio recebida - Configure uma API key do Gemini ou OpenAI para transcrição]',                                             
      type: 'transcription',                                                                                                                         
      provider: 'claude',                                                                                                                            
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // IMAGE ANALYSIS                                                                                                                                  
  // ============================================================================                                                                    
                                                                                                                                                     
  /**                                                                                                                                                
   * Analisa imagem usando o provider configurado do agent                                                                                           
   */                                                                                                                                                
  export async function analyzeImage(                                                                                                                
    agent: Agent,                                                                                                                                    
    mediaData: MediaData,                                                                                                                            
    prompt?: string                                                                                                                                  
  ): Promise<MediaAnalysisResult> {                                                                                                                  
    const provider = agent.ai_provider || 'gemini';                                                                                                  
    const analysisPrompt = prompt || 'Descreva o que você vê nesta imagem de forma clara e concisa.';                                                
                                                                                                                                                     
    logger.info('Analyzing image', {                                                                                                                 
      provider,                                                                                                                                      
      mimeType: mediaData.mimeType,                                                                                                                  
      hasBase64: !!mediaData.base64                                                                                                                  
    });                                                                                                                                              
                                                                                                                                                     
    try {                                                                                                                                            
      switch (provider) {                                                                                                                            
        case 'openai':                                                                                                                               
          return await analyzeWithOpenAI(agent, mediaData, analysisPrompt);                                                                          
        case 'gemini':                                                                                                                               
          return await analyzeWithGemini(agent, mediaData, analysisPrompt);                                                                          
        case 'claude':                                                                                                                               
          return await analyzeWithClaude(agent, mediaData, analysisPrompt);                                                                          
        default:                                                                                                                                     
          return await analyzeWithGemini(agent, mediaData, analysisPrompt);                                                                          
      }                                                                                                                                              
    } catch (error) {                                                                                                                                
      const errorMessage = error instanceof Error ? error.message : String(error);                                                                   
      logger.error('Image analysis failed', { provider, error: errorMessage });                                                                      
                                                                                                                                                     
      return {                                                                                                                                       
        success: false,                                                                                                                              
        text: '[Não foi possível analisar a imagem]',                                                                                                
        type: 'error',                                                                                                                               
        provider,                                                                                                                                    
      };                                                                                                                                             
    }                                                                                                                                                
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Analisa imagem usando OpenAI GPT-4 Vision                                                                                                       
   */                                                                                                                                                
  async function analyzeWithOpenAI(                                                                                                                  
    agent: Agent,                                                                                                                                    
    mediaData: MediaData,                                                                                                                            
    prompt: string                                                                                                                                   
  ): Promise<MediaAnalysisResult> {                                                                                                                  
    const apiKey = (agent as any).openai_api_key;                                                                                                    
    const model = (agent as any).openai_model || 'gpt-4o';                                                                                           
                                                                                                                                                     
    if (!apiKey) {                                                                                                                                   
      throw new Error('OpenAI API key not configured for this agent');                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    const client = new OpenAI({ apiKey });                                                                                                           
                                                                                                                                                     
    // Preparar base64 com prefixo correto                                                                                                           
    let imageData = mediaData.base64;                                                                                                                
    if (!imageData.startsWith('data:')) {                                                                                                            
      imageData = `data:${mediaData.mimeType};base64,${mediaData.base64}`;                                                                           
    }                                                                                                                                                
                                                                                                                                                     
    logger.debug('Calling OpenAI Vision', { model, mimeType: mediaData.mimeType });                                                                  
                                                                                                                                                     
    const response = await client.chat.completions.create({                                                                                          
      model,                                                                                                                                         
      messages: [                                                                                                                                    
        {                                                                                                                                            
          role: 'user',                                                                                                                              
          content: [                                                                                                                                 
            {                                                                                                                                        
              type: 'image_url',                                                                                                                     
              image_url: {                                                                                                                           
                url: imageData,                                                                                                                      
              },                                                                                                                                     
            },                                                                                                                                       
            {                                                                                                                                        
              type: 'text',                                                                                                                          
              text: prompt,                                                                                                                          
            },                                                                                                                                       
          ],                                                                                                                                         
        },                                                                                                                                           
      ],                                                                                                                                             
      max_tokens: 500,                                                                                                                               
    });                                                                                                                                              
                                                                                                                                                     
    const text = response.choices[0]?.message?.content || '';                                                                                        
                                                                                                                                                     
    logger.info('OpenAI vision completed', { textLength: text.length });                                                                             
                                                                                                                                                     
    return {                                                                                                                                         
      success: true,                                                                                                                                 
      text,                                                                                                                                          
      type: 'vision',                                                                                                                                
      provider: 'openai',                                                                                                                            
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Analisa imagem usando Gemini Vision                                                                                                             
   */                                                                                                                                                
  async function analyzeWithGemini(                                                                                                                  
    agent: Agent,                                                                                                                                    
    mediaData: MediaData,                                                                                                                            
    prompt: string                                                                                                                                   
  ): Promise<MediaAnalysisResult> {                                                                                                                  
    const apiKey = agent.gemini_api_key;                                                                                                             
    const modelName = agent.gemini_model || 'gemini-2.0-flash';                                                                                      
                                                                                                                                                     
    if (!apiKey) {                                                                                                                                   
      throw new Error('Gemini API key not configured for this agent');                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    const genAI = new GoogleGenerativeAI(apiKey);                                                                                                    
    const model = genAI.getGenerativeModel({ model: modelName });                                                                                    
                                                                                                                                                     
    // Limpar base64 usando helper universal                                                                                                         
    const base64Clean = cleanBase64Data(mediaData.base64);                                                                                           
                                                                                                                                                     
    logger.debug('Calling Gemini Vision', { model: modelName, mimeType: mediaData.mimeType });                                                       
                                                                                                                                                     
    const result = await model.generateContent([                                                                                                     
      prompt,                                                                                                                                        
      {                                                                                                                                              
        inlineData: {                                                                                                                                
          mimeType: mediaData.mimeType,                                                                                                              
          data: base64Clean,                                                                                                                         
        },                                                                                                                                           
      },                                                                                                                                             
    ]);                                                                                                                                              
                                                                                                                                                     
    const text = result.response.text();                                                                                                             
                                                                                                                                                     
    logger.info('Gemini vision completed', { textLength: text.length });                                                                             
                                                                                                                                                     
    return {                                                                                                                                         
      success: true,                                                                                                                                 
      text,                                                                                                                                          
      type: 'vision',                                                                                                                                
      provider: 'gemini',                                                                                                                            
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Analisa imagem usando Claude Vision                                                                                                             
   */                                                                                                                                                
  async function analyzeWithClaude(                                                                                                                  
    agent: Agent,                                                                                                                                    
    mediaData: MediaData,                                                                                                                            
    prompt: string                                                                                                                                   
  ): Promise<MediaAnalysisResult> {                                                                                                                  
    const Anthropic = (await import('@anthropic-ai/sdk')).default;                                                                                   
                                                                                                                                                     
    const apiKey = (agent as any).claude_api_key;                                                                                                    
    const model = (agent as any).claude_model || 'claude-sonnet-4-20250514';                                                                         
                                                                                                                                                     
    if (!apiKey) {                                                                                                                                   
      throw new Error('Claude API key not configured for this agent');                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    const client = new Anthropic({ apiKey });                                                                                                        
                                                                                                                                                     
    // Limpar base64 usando helper universal                                                                                                         
    const base64Clean = cleanBase64Data(mediaData.base64);                                                                                           
                                                                                                                                                     
    // Mapear mimeType para tipo aceito pelo Claude                                                                                                  
    const mediaType = mapToClaudeMediaType(mediaData.mimeType);                                                                                      
                                                                                                                                                     
    logger.debug('Calling Claude Vision', { model, mimeType: mediaType });                                                                           
                                                                                                                                                     
    const response = await client.messages.create({                                                                                                  
      model,                                                                                                                                         
      max_tokens: 500,                                                                                                                               
      messages: [                                                                                                                                    
        {                                                                                                                                            
          role: 'user',                                                                                                                              
          content: [                                                                                                                                 
            {                                                                                                                                        
              type: 'image',                                                                                                                         
              source: {                                                                                                                              
                type: 'base64',                                                                                                                      
                media_type: mediaType,                                                                                                               
                data: base64Clean,                                                                                                                   
              },                                                                                                                                     
            },                                                                                                                                       
            {                                                                                                                                        
              type: 'text',                                                                                                                          
              text: prompt,                                                                                                                          
            },                                                                                                                                       
          ],                                                                                                                                         
        },                                                                                                                                           
      ],                                                                                                                                             
    });                                                                                                                                              
                                                                                                                                                     
    // Extrair texto da resposta                                                                                                                     
    let text = '';                                                                                                                                   
    for (const block of response.content) {                                                                                                          
      if (block.type === 'text') {                                                                                                                   
        text += block.text;                                                                                                                          
      }                                                                                                                                              
    }                                                                                                                                                
                                                                                                                                                     
    logger.info('Claude vision completed', { textLength: text.length });                                                                             
                                                                                                                                                     
    return {                                                                                                                                         
      success: true,                                                                                                                                 
      text,                                                                                                                                          
      type: 'vision',                                                                                                                                
      provider: 'claude',                                                                                                                            
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // HELPERS                                                                                                                                         
  // ============================================================================                                                                    
                                                                                                                                                     
  /**                                                                                                                                                
   * Remove prefixo data:xxx;base64, do base64 de forma universal                                                                                    
   * Funciona para qualquer tipo de mídia (audio, image, video, etc)                                                                                 
   */                                                                                                                                                
  function cleanBase64Data(base64: string): string {                                                                                                 
    // Regex universal que remove qualquer prefixo data:mimetype;base64,                                                                             
    return base64.replace(/^data:[^;]+;base64,/i, '');                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Obtém extensão de arquivo de áudio a partir do mimeType                                                                                         
   */                                                                                                                                                
  function getAudioExtension(mimeType: string): string {                                                                                             
    const mimeToExtension: Record<string, string> = {                                                                                                
      'audio/ogg': 'ogg',                                                                                                                            
      'audio/ogg; codecs=opus': 'ogg',                                                                                                               
      'audio/opus': 'opus',                                                                                                                          
      'audio/mpeg': 'mp3',                                                                                                                           
      'audio/mp3': 'mp3',                                                                                                                            
      'audio/mp4': 'm4a',                                                                                                                            
      'audio/m4a': 'm4a',                                                                                                                            
      'audio/wav': 'wav',                                                                                                                            
      'audio/wave': 'wav',                                                                                                                           
      'audio/x-wav': 'wav',                                                                                                                          
      'audio/webm': 'webm',                                                                                                                          
      'audio/flac': 'flac',                                                                                                                          
    };                                                                                                                                               
                                                                                                                                                     
    const normalizedMime = mimeType.split(';')[0].trim().toLowerCase();                                                                              
    return mimeToExtension[normalizedMime] || 'ogg';                                                                                                 
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Mapeia mimeType para tipo aceito pelo Claude                                                                                                    
   */                                                                                                                                                
  function mapToClaudeMediaType(mimeType: string): 'image/jpeg' | 'image/png' | 'image/gif' | 'image/webp' {                                         
    const normalizedMime = mimeType.split(';')[0].trim().toLowerCase();                                                                              
                                                                                                                                                     
    if (normalizedMime === 'image/jpeg' || normalizedMime === 'image/jpg') {                                                                         
      return 'image/jpeg';                                                                                                                           
    }                                                                                                                                                
    if (normalizedMime === 'image/png') {                                                                                                            
      return 'image/png';                                                                                                                            
    }                                                                                                                                                
    if (normalizedMime === 'image/gif') {                                                                                                            
      return 'image/gif';                                                                                                                            
    }                                                                                                                                                
    if (normalizedMime === 'image/webp') {                                                                                                           
      return 'image/webp';                                                                                                                           
    }                                                                                                                                                
                                                                                                                                                     
    // Default para jpeg                                                                                                                             
    return 'image/jpeg';                                                                                                                             
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Determina se um mimeType é de áudio                                                                                                             
   */                                                                                                                                                
  export function isAudioMimeType(mimeType: string): boolean {                                                                                       
    return mimeType.startsWith('audio/');                                                                                                            
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Determina se um mimeType é de imagem                                                                                                            
   */                                                                                                                                                
  export function isImageMimeType(mimeType: string): boolean {                                                                                       
    return mimeType.startsWith('image/');                                                                                                            
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Determina se um mimeType é de vídeo                                                                                                             
   */                                                                                                                                                
  export function isVideoMimeType(mimeType: string): boolean {                                                                                       
    return mimeType.startsWith('video/');                                                                                                            
  }                                                                                                                                                  
                                                                                                                                                     
  ---                                                                                                                                                
  Parte 37: services/ai/ai-factory.ts (548 linhas)                                                                                                   
                                                                                                                                                     
  /**                                                                                                                                                
   * AI Factory - Abstrai a criacao de clientes de IA                                                                                                
   * Suporta: Gemini, Claude, OpenAI                                                                                                                 
   */                                                                                                                                                
                                                                                                                                                     
  import { GeminiClient, createGeminiClient, GeminiChatOptions, GeminiChatWithToolsOptions, GeminiResponse, GeminiResponseWithTools,                 
  GeminiFunctionDeclarationInput } from './gemini-client';                                                                                           
  import { ClaudeClient, createClaudeClient } from './claude';                                                                                       
  import { OpenAIClient, createOpenAIClient, OpenAIChatOptions, OpenAIChatWithToolsOptions, OpenAIFunctionDeclaration } from './openai-client';      
                                                                                                                                                     
  // ============================================================================                                                                    
  // TYPES                                                                                                                                           
  // ============================================================================                                                                    
                                                                                                                                                     
  export type AIProvider = 'gemini' | 'claude' | 'openai';                                                                                           
                                                                                                                                                     
  export interface AIConfig {                                                                                                                        
    provider: AIProvider;                                                                                                                            
    apiKey: string;                                                                                                                                  
    model?: string;                                                                                                                                  
  }                                                                                                                                                  
                                                                                                                                                     
  export interface AIMessage {                                                                                                                       
    role: 'user' | 'assistant' | 'system';                                                                                                           
    content: string;                                                                                                                                 
  }                                                                                                                                                  
                                                                                                                                                     
  export interface AIChatOptions {                                                                                                                   
    systemPrompt?: string;                                                                                                                           
    history?: AIMessage[];                                                                                                                           
    message: string;                                                                                                                                 
    maxTokens?: number;                                                                                                                              
    temperature?: number;                                                                                                                            
  }                                                                                                                                                  
                                                                                                                                                     
  export interface AIFunctionDeclaration {                                                                                                           
    name: string;                                                                                                                                    
    description: string;                                                                                                                             
    parameters: {                                                                                                                                    
      type: 'object';                                                                                                                                
      properties: Record<string, {                                                                                                                   
        type: string;                                                                                                                                
        description?: string;                                                                                                                        
        enum?: string[];                                                                                                                             
      }>;                                                                                                                                            
      required?: string[];                                                                                                                           
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  export interface AIFunctionCall {                                                                                                                  
    name: string;                                                                                                                                    
    args: Record<string, unknown>;                                                                                                                   
  }                                                                                                                                                  
                                                                                                                                                     
  export type AIFunctionCallingMode = 'auto' | 'required' | 'none';                                                                                  
                                                                                                                                                     
  export interface AIChatWithToolsOptions extends AIChatOptions {                                                                                    
    tools?: AIFunctionDeclaration[];                                                                                                                 
    onFunctionCall?: (functionCall: AIFunctionCall) => Promise<Record<string, unknown>>;                                                             
    functionCallingMode?: AIFunctionCallingMode;                                                                                                     
    allowedFunctions?: string[];                                                                                                                     
  }                                                                                                                                                  
                                                                                                                                                     
  export interface AIResponse {                                                                                                                      
    text: string;                                                                                                                                    
    tokensUsed?: {                                                                                                                                   
      input: number;                                                                                                                                 
      output: number;                                                                                                                                
    };                                                                                                                                               
  }                                                                                                                                                  
                                                                                                                                                     
  export interface AIResponseWithTools extends AIResponse {                                                                                          
    functionCall?: AIFunctionCall;                                                                                                                   
    finishReason?: string;                                                                                                                           
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // AVAILABLE MODELS                                                                                                                                
  // ============================================================================                                                                    
                                                                                                                                                     
  export const AI_MODELS: Record<AIProvider, Array<{ id: string; name: string; description: string }>> = {                                           
    gemini: [                                                                                                                                        
      { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash', description: 'Rapido e estavel (Recomendado)' },                                           
      { id: 'gemini-2.5-flash', name: 'Gemini 2.5 Flash', description: 'Rapido com boa qualidade' },                                                 
    ],                                                                                                                                               
    claude: [                                                                                                                                        
      { id: 'claude-sonnet-4-20250514', name: 'Claude Sonnet 4', description: 'Mais recente e capaz' },                                              
      { id: 'claude-3-5-sonnet-20241022', name: 'Claude 3.5 Sonnet', description: 'Excelente equilibrio' },                                          
      { id: 'claude-3-haiku-20240307', name: 'Claude 3 Haiku', description: 'Mais rapido e economico' },                                             
    ],                                                                                                                                               
    openai: [                                                                                                                                        
      { id: 'gpt-4o', name: 'GPT-4o', description: 'Mais capaz e multimodal' },                                                                      
      { id: 'gpt-4o-mini', name: 'GPT-4o Mini', description: 'Rapido e economico' },                                                                 
      { id: 'gpt-4-turbo', name: 'GPT-4 Turbo', description: 'Alta capacidade' },                                                                    
      { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', description: 'Economico, bom para tarefas simples' },                                            
    ],                                                                                                                                               
  };                                                                                                                                                 
                                                                                                                                                     
  export const DEFAULT_MODELS: Record<AIProvider, string> = {                                                                                        
    gemini: 'gemini-2.0-flash',                                                                                                                      
    claude: 'claude-sonnet-4-20250514',                                                                                                              
    openai: 'gpt-4o-mini',                                                                                                                           
  };                                                                                                                                                 
                                                                                                                                                     
  // ============================================================================                                                                    
  // RESPONSE SIZE CONFIGURATION                                                                                                                     
  // ============================================================================                                                                    
                                                                                                                                                     
  export type ResponseSize = 'short' | 'medium' | 'long';                                                                                            
                                                                                                                                                     
  export interface ResponseSizeConfig {                                                                                                              
    maxTokens: number;                                                                                                                               
    instruction: string;                                                                                                                             
  }                                                                                                                                                  
                                                                                                                                                     
  export const RESPONSE_SIZE_CONFIG: Record<ResponseSize, ResponseSizeConfig> = {                                                                    
    short: {                                                                                                                                         
      maxTokens: 150,                                                                                                                                
      instruction: 'IMPORTANTE: Seja EXTREMAMENTE conciso. Responda em no máximo 1-2 frases curtas e diretas. Vá direto ao ponto sem rodeios.',      
    },                                                                                                                                               
    medium: {                                                                                                                                        
      maxTokens: 500,                                                                                                                                
      instruction: 'Responda de forma clara, objetiva e natural. Use parágrafos curtos quando necessário.',                                          
    },                                                                                                                                               
    long: {                                                                                                                                          
      maxTokens: 1000,                                                                                                                               
      instruction: 'Forneça uma resposta detalhada e completa. Pode usar múltiplos parágrafos para explicar bem o assunto.',                         
    },                                                                                                                                               
  };                                                                                                                                                 
                                                                                                                                                     
  /**                                                                                                                                                
   * Obtém a configuração de tamanho de resposta                                                                                                     
   */                                                                                                                                                
  export function getResponseSizeConfig(size: ResponseSize | undefined): ResponseSizeConfig {                                                        
    return RESPONSE_SIZE_CONFIG[size || 'medium'];                                                                                                   
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // UNIFIED AI CLIENT                                                                                                                               
  // ============================================================================                                                                    
                                                                                                                                                     
  export class UnifiedAIClient {                                                                                                                     
    private provider: AIProvider;                                                                                                                    
    private geminiClient?: GeminiClient;                                                                                                             
    private claudeClient?: ClaudeClient;                                                                                                             
    private openaiClient?: OpenAIClient;                                                                                                             
                                                                                                                                                     
    constructor(config: AIConfig) {                                                                                                                  
      this.provider = config.provider;                                                                                                               
                                                                                                                                                     
      switch (config.provider) {                                                                                                                     
        case 'gemini':                                                                                                                               
          this.geminiClient = createGeminiClient({                                                                                                   
            apiKey: config.apiKey,                                                                                                                   
            model: config.model || DEFAULT_MODELS.gemini,                                                                                            
          });                                                                                                                                        
          break;                                                                                                                                     
                                                                                                                                                     
        case 'claude':                                                                                                                               
          this.claudeClient = createClaudeClient(                                                                                                    
            config.apiKey,                                                                                                                           
            config.model || DEFAULT_MODELS.claude                                                                                                    
          );                                                                                                                                         
          break;                                                                                                                                     
                                                                                                                                                     
        case 'openai':                                                                                                                               
          this.openaiClient = createOpenAIClient({                                                                                                   
            apiKey: config.apiKey,                                                                                                                   
            model: config.model || DEFAULT_MODELS.openai,                                                                                            
          });                                                                                                                                        
          break;                                                                                                                                     
                                                                                                                                                     
        default:                                                                                                                                     
          throw new Error(`Unknown AI provider: ${config.provider}`);                                                                                
      }                                                                                                                                              
                                                                                                                                                     
      console.info(`[UnifiedAIClient] Initialized with provider: ${config.provider}, model: ${config.model || DEFAULT_MODELS[config.provider]}`);    
    }                                                                                                                                                
                                                                                                                                                     
    // ========================================================================                                                                      
    // SIMPLE CHAT                                                                                                                                   
    // ========================================================================                                                                      
                                                                                                                                                     
    async chat(options: AIChatOptions): Promise<AIResponse> {                                                                                        
      switch (this.provider) {                                                                                                                       
        case 'gemini':                                                                                                                               
          return this.chatWithGemini(options);                                                                                                       
                                                                                                                                                     
        case 'claude':                                                                                                                               
          return this.chatWithClaude(options);                                                                                                       
                                                                                                                                                     
        case 'openai':                                                                                                                               
          return this.chatWithOpenAI(options);                                                                                                       
                                                                                                                                                     
        default:                                                                                                                                     
          throw new Error(`Unknown provider: ${this.provider}`);                                                                                     
      }                                                                                                                                              
    }                                                                                                                                                
                                                                                                                                                     
    private async chatWithGemini(options: AIChatOptions): Promise<AIResponse> {                                                                      
      if (!this.geminiClient) throw new Error('Gemini client not initialized');                                                                      
                                                                                                                                                     
      const geminiHistory = options.history?.map(msg => ({                                                                                           
        role: msg.role === 'assistant' ? 'model' as const : 'user' as const,                                                                         
        parts: [{ text: msg.content }],                                                                                                              
      }));                                                                                                                                           
                                                                                                                                                     
      const response = await this.geminiClient.chat({                                                                                                
        systemPrompt: options.systemPrompt,                                                                                                          
        history: geminiHistory,                                                                                                                      
        message: options.message,                                                                                                                    
        maxTokens: options.maxTokens,                                                                                                                
        temperature: options.temperature,                                                                                                            
      });                                                                                                                                            
                                                                                                                                                     
      return {                                                                                                                                       
        text: response.text,                                                                                                                         
        tokensUsed: response.tokensUsed,                                                                                                             
      };                                                                                                                                             
    }                                                                                                                                                
                                                                                                                                                     
    private async chatWithClaude(options: AIChatOptions): Promise<AIResponse> {                                                                      
      if (!this.claudeClient) throw new Error('Claude client not initialized');                                                                      
                                                                                                                                                     
      const claudeMessages = options.history?.map(msg => ({                                                                                          
        role: msg.role as 'user' | 'assistant',                                                                                                      
        content: msg.content,                                                                                                                        
      })) || [];                                                                                                                                     
                                                                                                                                                     
      // Adicionar mensagem atual                                                                                                                    
      claudeMessages.push({                                                                                                                          
        role: 'user',                                                                                                                                
        content: options.message,                                                                                                                    
      });                                                                                                                                            
                                                                                                                                                     
      const response = await this.claudeClient.sendMessage({                                                                                         
        systemPrompt: options.systemPrompt || '',                                                                                                    
        messages: claudeMessages,                                                                                                                    
        maxTokens: options.maxTokens,                                                                                                                
        temperature: options.temperature,                                                                                                            
      });                                                                                                                                            
                                                                                                                                                     
      // Extrair texto da resposta                                                                                                                   
      let text = '';                                                                                                                                 
      for (const block of response.content) {                                                                                                        
        if (block.type === 'text') {                                                                                                                 
          text += block.text;                                                                                                                        
        }                                                                                                                                            
      }                                                                                                                                              
                                                                                                                                                     
      return {                                                                                                                                       
        text,                                                                                                                                        
        tokensUsed: {                                                                                                                                
          input: response.usage.input_tokens,                                                                                                        
          output: response.usage.output_tokens,                                                                                                      
        },                                                                                                                                           
      };                                                                                                                                             
    }                                                                                                                                                
                                                                                                                                                     
    private async chatWithOpenAI(options: AIChatOptions): Promise<AIResponse> {                                                                      
      if (!this.openaiClient) throw new Error('OpenAI client not initialized');                                                                      
                                                                                                                                                     
      const openaiHistory = options.history?.map(msg => ({                                                                                           
        role: msg.role as 'user' | 'assistant' | 'system',                                                                                           
        content: msg.content,                                                                                                                        
      }));                                                                                                                                           
                                                                                                                                                     
      const response = await this.openaiClient.chat({                                                                                                
        systemPrompt: options.systemPrompt,                                                                                                          
        history: openaiHistory,                                                                                                                      
        message: options.message,                                                                                                                    
        maxTokens: options.maxTokens,                                                                                                                
        temperature: options.temperature,                                                                                                            
      });                                                                                                                                            
                                                                                                                                                     
      return response;                                                                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    // ========================================================================                                                                      
    // CHAT WITH TOOLS                                                                                                                               
    // ========================================================================                                                                      
                                                                                                                                                     
    async chatWithTools(options: AIChatWithToolsOptions): Promise<AIResponseWithTools> {                                                             
      switch (this.provider) {                                                                                                                       
        case 'gemini':                                                                                                                               
          return this.chatWithToolsGemini(options);                                                                                                  
                                                                                                                                                     
        case 'claude':                                                                                                                               
          return this.chatWithToolsClaude(options);                                                                                                  
                                                                                                                                                     
        case 'openai':                                                                                                                               
          return this.chatWithToolsOpenAI(options);                                                                                                  
                                                                                                                                                     
        default:                                                                                                                                     
          throw new Error(`Unknown provider: ${this.provider}`);                                                                                     
      }                                                                                                                                              
    }                                                                                                                                                
                                                                                                                                                     
    private async chatWithToolsGemini(options: AIChatWithToolsOptions): Promise<AIResponseWithTools> {                                               
      if (!this.geminiClient) throw new Error('Gemini client not initialized');                                                                      
                                                                                                                                                     
      const geminiHistory = options.history?.map(msg => ({                                                                                           
        role: msg.role === 'assistant' ? 'model' as const : 'user' as const,                                                                         
        parts: [{ text: msg.content }],                                                                                                              
      }));                                                                                                                                           
                                                                                                                                                     
      // Converter tools para formato Gemini                                                                                                         
      const geminiTools: GeminiFunctionDeclarationInput[] = options.tools?.map(tool => ({                                                            
        name: tool.name,                                                                                                                             
        description: tool.description,                                                                                                               
        parameters: tool.parameters,                                                                                                                 
      })) || [];                                                                                                                                     
                                                                                                                                                     
      // Converter modo                                                                                                                              
      let geminiMode: 'AUTO' | 'ANY' | 'NONE' = 'AUTO';                                                                                              
      if (options.functionCallingMode === 'required') geminiMode = 'ANY';                                                                            
      if (options.functionCallingMode === 'none') geminiMode = 'NONE';                                                                               
                                                                                                                                                     
      const geminiOptions: GeminiChatWithToolsOptions = {                                                                                            
        systemPrompt: options.systemPrompt,                                                                                                          
        history: geminiHistory,                                                                                                                      
        message: options.message,                                                                                                                    
        maxTokens: options.maxTokens,                                                                                                                
        temperature: options.temperature,                                                                                                            
        tools: geminiTools,                                                                                                                          
        functionCallingMode: geminiMode,                                                                                                             
        allowedFunctions: options.allowedFunctions,                                                                                                  
        onFunctionCall: options.onFunctionCall ? async (fc) => {                                                                                     
          return options.onFunctionCall!({ name: fc.name, args: fc.args });                                                                          
        } : undefined,                                                                                                                               
      };                                                                                                                                             
                                                                                                                                                     
      const response = await this.geminiClient.chatWithTools(geminiOptions);                                                                         
                                                                                                                                                     
      return {                                                                                                                                       
        text: response.text,                                                                                                                         
        tokensUsed: response.tokensUsed,                                                                                                             
        functionCall: response.functionCall ? {                                                                                                      
          name: response.functionCall.name,                                                                                                          
          args: response.functionCall.args,                                                                                                          
        } : undefined,                                                                                                                               
        finishReason: response.finishReason,                                                                                                         
      };                                                                                                                                             
    }                                                                                                                                                
                                                                                                                                                     
    private async chatWithToolsClaude(options: AIChatWithToolsOptions): Promise<AIResponseWithTools> {                                               
      if (!this.claudeClient) throw new Error('Claude client not initialized');                                                                      
                                                                                                                                                     
      const claudeMessages = options.history?.map(msg => ({                                                                                          
        role: msg.role as 'user' | 'assistant',                                                                                                      
        content: msg.content,                                                                                                                        
      })) || [];                                                                                                                                     
                                                                                                                                                     
      // Adicionar mensagem atual                                                                                                                    
      claudeMessages.push({                                                                                                                          
        role: 'user',                                                                                                                                
        content: options.message,                                                                                                                    
      });                                                                                                                                            
                                                                                                                                                     
      // Converter tools para formato Claude                                                                                                         
      const claudeTools = options.tools?.map(tool => ({                                                                                              
        name: tool.name,                                                                                                                             
        description: tool.description,                                                                                                               
        input_schema: {                                                                                                                              
          type: 'object' as const,                                                                                                                   
          properties: tool.parameters.properties,                                                                                                    
          required: tool.parameters.required,                                                                                                        
        },                                                                                                                                           
      })) || [];                                                                                                                                     
                                                                                                                                                     
      const response = await this.claudeClient.sendWithTools({                                                                                       
        systemPrompt: options.systemPrompt || '',                                                                                                    
        messages: claudeMessages,                                                                                                                    
        tools: claudeTools as any,                                                                                                                   
        maxTokens: options.maxTokens,                                                                                                                
        temperature: options.temperature,                                                                                                            
      });                                                                                                                                            
                                                                                                                                                     
      // Extrair texto e tool calls                                                                                                                  
      let text = '';                                                                                                                                 
      let functionCall: AIFunctionCall | undefined;                                                                                                  
                                                                                                                                                     
      for (const block of response.content) {                                                                                                        
        if (block.type === 'text') {                                                                                                                 
          text += block.text;                                                                                                                        
        } else if (block.type === 'tool_use') {                                                                                                      
          functionCall = {                                                                                                                           
            name: block.name,                                                                                                                        
            args: block.input as Record<string, unknown>,                                                                                            
          };                                                                                                                                         
                                                                                                                                                     
          // Se tem callback, executar                                                                                                               
          if (options.onFunctionCall && functionCall) {                                                                                              
            const result = await options.onFunctionCall(functionCall);                                                                               
                                                                                                                                                     
            // Continuar com resultado                                                                                                               
            const continuedResponse = await this.claudeClient.continueWithToolResults(                                                               
              {                                                                                                                                      
                systemPrompt: options.systemPrompt || '',                                                                                            
                messages: claudeMessages,                                                                                                            
                tools: claudeTools as any,                                                                                                           
                maxTokens: options.maxTokens,                                                                                                        
                temperature: options.temperature,                                                                                                    
              },                                                                                                                                     
              response,                                                                                                                              
              [{                                                                                                                                     
                tool_use_id: block.id,                                                                                                               
                content: JSON.stringify(result),                                                                                                     
              }]                                                                                                                                     
            );                                                                                                                                       
                                                                                                                                                     
            // Extrair texto final                                                                                                                   
            text = '';                                                                                                                               
            for (const contBlock of continuedResponse.content) {                                                                                     
              if (contBlock.type === 'text') {                                                                                                       
                text += contBlock.text;                                                                                                              
              }                                                                                                                                      
            }                                                                                                                                        
                                                                                                                                                     
            return {                                                                                                                                 
              text,                                                                                                                                  
              functionCall,                                                                                                                          
              tokensUsed: {                                                                                                                          
                input: continuedResponse.usage.input_tokens,                                                                                         
                output: continuedResponse.usage.output_tokens,                                                                                       
              },                                                                                                                                     
              finishReason: continuedResponse.stop_reason || undefined,                                                                              
            };                                                                                                                                       
          }                                                                                                                                          
        }                                                                                                                                            
      }                                                                                                                                              
                                                                                                                                                     
      return {                                                                                                                                       
        text,                                                                                                                                        
        functionCall,                                                                                                                                
        tokensUsed: {                                                                                                                                
          input: response.usage.input_tokens,                                                                                                        
          output: response.usage.output_tokens,                                                                                                      
        },                                                                                                                                           
        finishReason: response.stop_reason || undefined,                                                                                             
      };                                                                                                                                             
    }                                                                                                                                                
                                                                                                                                                     
    private async chatWithToolsOpenAI(options: AIChatWithToolsOptions): Promise<AIResponseWithTools> {                                               
      if (!this.openaiClient) throw new Error('OpenAI client not initialized');                                                                      
                                                                                                                                                     
      const openaiHistory = options.history?.map(msg => ({                                                                                           
        role: msg.role as 'user' | 'assistant' | 'system',                                                                                           
        content: msg.content,                                                                                                                        
      }));                                                                                                                                           
                                                                                                                                                     
      // Converter tools para formato OpenAI                                                                                                         
      const openaiTools: OpenAIFunctionDeclaration[] = options.tools?.map(tool => ({                                                                 
        name: tool.name,                                                                                                                             
        description: tool.description,                                                                                                               
        parameters: tool.parameters,                                                                                                                 
      })) || [];                                                                                                                                     
                                                                                                                                                     
      // Converter modo                                                                                                                              
      let openaiMode: 'auto' | 'required' | 'none' = 'auto';                                                                                         
      if (options.functionCallingMode === 'required') openaiMode = 'required';                                                                       
      if (options.functionCallingMode === 'none') openaiMode = 'none';                                                                               
                                                                                                                                                     
      const response = await this.openaiClient.chatWithTools({                                                                                       
        systemPrompt: options.systemPrompt,                                                                                                          
        history: openaiHistory,                                                                                                                      
        message: options.message,                                                                                                                    
        maxTokens: options.maxTokens,                                                                                                                
        temperature: options.temperature,                                                                                                            
        tools: openaiTools,                                                                                                                          
        functionCallingMode: openaiMode,                                                                                                             
        allowedFunctions: options.allowedFunctions,                                                                                                  
        onFunctionCall: options.onFunctionCall,                                                                                                      
      });                                                                                                                                            
                                                                                                                                                     
      return response;                                                                                                                               
    }                                                                                                                                                
                                                                                                                                                     
    // ========================================================================                                                                      
    // UTILITY                                                                                                                                       
    // ========================================================================                                                                      
                                                                                                                                                     
    getProvider(): AIProvider {                                                                                                                      
      return this.provider;                                                                                                                          
    }                                                                                                                                                
  }                                                                                                                                                  
                                                                                                                                                     
  // ============================================================================                                                                    
  // FACTORY FUNCTION                                                                                                                                
  // ============================================================================                                                                    
                                                                                                                                                     
  export function createAIClient(config: AIConfig): UnifiedAIClient {                                                                                
    return new UnifiedAIClient(config);                                                                                                              
  }                                                                                                                                                  
                                                                                                                                                     
  /**                                                                                                                                                
   * Helper para criar cliente a partir de dados do agent                                                                                            
   */                                                                                                                                                
  export function createAIClientFromAgent(agent: {                                                                                                   
    ai_provider?: AIProvider | null;                                                                                                                 
    gemini_api_key?: string | null;                                                                                                                  
    gemini_model?: string | null;                                                                                                                    
    claude_api_key?: string | null;                                                                                                                  
    claude_model?: string | null;                                                                                                                    
    openai_api_key?: string | null;                                                                                                                  
    openai_model?: string | null;                                                                                                                    
  }): UnifiedAIClient {                                                                                                                              
    // Determinar provider (default: gemini para compatibilidade)                                                                                    
    const provider = agent.ai_provider || 'gemini';                                                                                                  
                                                                                                                                                     
    let apiKey: string;                                                                                                                              
    let model: string | undefined;                                                                                                                   
                                                                                                                                                     
    switch (provider) {                                                                                                                              
      case 'gemini':                                                                                                                                 
        if (!agent.gemini_api_key) {                                                                                                                 
          throw new Error('Gemini API key is required');                                                                                             
        }                                                                                                                                            
        apiKey = agent.gemini_api_key;                                                                                                               
        model = agent.gemini_model || undefined;                                                                                                     
        break;                                                                                                                                       
                                                                                                                                                     
      case 'claude':                                                                                                                                 
        if (!agent.claude_api_key) {                                                                                                                 
          throw new Error('Claude API key is required');                                                                                             
        }                                                                                                                                            
        apiKey = agent.claude_api_key;                                                                                                               
        model = agent.claude_model || undefined;                                                                                                     
        break;                                                                                                                                       
                                                                                                                                                     
      case 'openai':                                                                                                                                 
        if (!agent.openai_api_key) {                                                                                                                 
          throw new Error('OpenAI API key is required');                                                                                             
        }                                                                                                                                            
        apiKey = agent.openai_api_key;                                                                                                               
        model = agent.openai_model || undefined;                                                                                                     
        break;                                                                                                                                       
                                                                                                                                                     
      default:                                                                                                                                       
        throw new Error(`Unknown AI provider: ${provider}`);                                                                                         
    }                                                                                                                                                
                                                                                                                                                     
    return createAIClient({                                                                                                                          
      provider,                                                                                                                                      
      apiKey,                                                                                                                                        
      model,                                                                                                                                         
    });                                                                                                                                              
  }                                                                                                                                                  
                                                                                                                                                     
  ---                                                 