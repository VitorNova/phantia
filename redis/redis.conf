# ============================================
# PHANTIA - Redis Configuration
# Cache de contexto para agentes IA
# ============================================

# ============================================
# SEGURANÇA
# ============================================

# Senha de acesso (usar variável de ambiente em produção)
# Em produção, definir via: redis-server --requirepass $REDIS_PASSWORD
requirepass phantia_redis_dev_password_change_in_production

# Modo protegido (só aceita conexões autenticadas)
protected-mode yes

# Bind - aceita conexões de qualquer interface dentro do container
bind 0.0.0.0

# ============================================
# PERSISTÊNCIA RDB (Snapshots)
# ============================================

# Salvar após 900 segundos se pelo menos 1 chave mudou
save 900 1

# Salvar após 300 segundos se pelo menos 10 chaves mudaram
save 300 10

# Salvar após 60 segundos se pelo menos 10000 chaves mudaram
save 60 10000

# Nome do arquivo de dump
dbfilename dump.rdb

# Diretório de dados
dir /data

# Parar de escrever se o RDB falhar
stop-writes-on-bgsave-error yes

# Comprimir dados RDB
rdbcompression yes

# Checksum para validar RDB
rdbchecksum yes

# ============================================
# PERSISTÊNCIA AOF (Append Only File)
# ============================================

# Habilitar AOF para durabilidade
appendonly yes

# Nome do arquivo AOF
appendfilename "appendonly.aof"

# Sincronizar a cada segundo (equilíbrio entre performance e durabilidade)
appendfsync everysec

# Não reescrever AOF durante BGSAVE
no-appendfsync-on-rewrite no

# Reescrever AOF quando crescer 100%
auto-aof-rewrite-percentage 100

# Tamanho mínimo para reescrita
auto-aof-rewrite-min-size 64mb

# ============================================
# MEMÓRIA
# ============================================

# Limite de memória (512MB para cache de contexto)
maxmemory 512mb

# Política de evição: remover chaves menos usadas recentemente
# Ideal para cache de sessões/contexto
maxmemory-policy allkeys-lru

# Samples para LRU (quanto maior, mais preciso mas mais lento)
maxmemory-samples 5

# ============================================
# PERFORMANCE
# ============================================

# Timeout de conexão (0 = sem timeout)
timeout 0

# TCP keepalive
tcp-keepalive 300

# Backlog de conexões TCP
tcp-backlog 511

# ============================================
# LOGS
# ============================================

# Nível de log
loglevel notice

# Log para stdout (Docker coleta automaticamente)
logfile ""

# ============================================
# SEGURANÇA AVANÇADA
# ============================================

# Desabilitar comandos perigosos em produção
rename-command FLUSHALL ""
rename-command FLUSHDB ""
rename-command DEBUG ""
rename-command CONFIG ""
rename-command SHUTDOWN PHANTIA_SHUTDOWN
rename-command BGREWRITEAOF PHANTIA_BGREWRITEAOF
rename-command BGSAVE PHANTIA_BGSAVE

# ============================================
# LIMITES
# ============================================

# Máximo de clientes simultâneos
maxclients 1000

# ============================================
# LAZY FREEING (Performance)
# ============================================

# Usar lazy free para DEL assíncrono
lazyfree-lazy-eviction yes
lazyfree-lazy-expire yes
lazyfree-lazy-server-del yes

# ============================================
# SLOW LOG
# ============================================

# Log queries mais lentas que 10ms
slowlog-log-slower-than 10000

# Manter últimas 128 queries lentas
slowlog-max-len 128
